<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J.A.R.V.I.S. - Fab Lab Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #00d4ff;
            --primary-dim: rgba(0, 212, 255, 0.3);
            --secondary: #ff6b35;
            --success: #00ff88;
            --warning: #ffaa00;
            --danger: #ff4444;
            --bg-dark: #0a0a12;
            --bg-panel: rgba(0, 20, 40, 0.85);
            --glow: 0 0 20px rgba(0, 212, 255, 0.5);
        }

        body {
            background: var(--bg-dark);
            color: var(--primary);
            font-family: 'Rajdhani', sans-serif;
            overflow: hidden;
            height: 100vh;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background:
                linear-gradient(rgba(0, 212, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 212, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: -1;
        }

        .container {
            display: grid;
            grid-template-columns: 300px 1fr 320px;
            grid-template-rows: 70px 1fr 140px;
            height: 100vh;
            gap: 10px;
            padding: 10px;
        }

        .header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            background: var(--bg-panel);
            border-bottom: 2px solid var(--primary-dim);
        }

        .logo {
            font-family: 'Orbitron', monospace;
            font-size: 2rem;
            font-weight: 900;
            letter-spacing: 0.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, #fff 50%, var(--primary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .status-bar { display: flex; gap: 20px; align-items: center; }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--primary-dim);
            border-radius: 4px;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.1rem;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success);
            box-shadow: 0 0 10px var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .clock {
            font-family: 'Orbitron', monospace;
            font-size: 1.2rem;
            color: var(--primary);
        }

        .panel {
            background: var(--bg-panel);
            border: 1px solid var(--primary-dim);
            padding: 15px;
            position: relative;
        }

        .panel::before, .panel::after {
            content: '';
            position: absolute;
            width: 15px;
            height: 15px;
            border-color: var(--primary);
            border-style: solid;
        }

        .panel::before { top: 0; left: 0; border-width: 2px 0 0 2px; }
        .panel::after { bottom: 0; right: 0; border-width: 0 2px 2px 0; }

        .panel-title {
            font-family: 'Orbitron', monospace;
            font-size: 0.7rem;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.2rem;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--primary-dim);
        }

        .panel-title::before { content: '// '; color: var(--secondary); }

        .left-panel { display: flex; flex-direction: column; }

        .tab-buttons { display: flex; gap: 5px; margin-bottom: 15px; }

        .tab-btn {
            flex: 1;
            padding: 8px 5px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--primary-dim);
            color: var(--primary);
            font-family: 'Orbitron', monospace;
            font-size: 0.6rem;
            cursor: pointer;
            text-transform: uppercase;
        }

        .tab-btn:hover { background: var(--primary-dim); }

        .tab-btn.active {
            background: var(--primary);
            color: var(--bg-dark);
            border-color: var(--primary);
        }

        .tab-content { display: none; flex: 1; overflow-y: auto; }
        .tab-content.active { display: block; }

        .system-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0, 212, 255, 0.1);
        }

        .system-label { color: rgba(255, 255, 255, 0.6); font-size: 0.85rem; }

        .system-value {
            font-family: 'Orbitron', monospace;
            color: var(--success);
            font-size: 1rem;
        }

        .material-slot {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            margin-bottom: 8px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 4px;
            cursor: pointer;
        }

        .material-slot:hover { border-color: var(--primary); }
        .material-slot.selected { border-color: var(--success); box-shadow: 0 0 10px rgba(0, 255, 136, 0.3); }

        .material-color {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.4);
        }

        .material-info { flex: 1; }
        .material-name { font-size: 0.9rem; font-weight: 600; }
        .material-detail { font-size: 0.7rem; color: rgba(255, 255, 255, 0.5); }
        .material-amount { font-family: 'Orbitron', monospace; font-size: 0.8rem; color: var(--primary); }

        .scan-item {
            padding: 12px;
            margin-bottom: 8px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 4px;
            cursor: pointer;
        }

        .scan-item:hover { border-color: var(--primary); }
        .scan-item.active { border-color: var(--success); background: rgba(0, 255, 136, 0.1); }
        .scan-name { font-size: 0.9rem; font-weight: 600; margin-bottom: 5px; }
        .scan-meta { font-size: 0.7rem; color: rgba(255, 255, 255, 0.5); }

        /* Temperature Chart */
        .temp-chart-container {
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px solid var(--primary-dim);
        }
        .temp-chart-container canvas { width: 100% !important; height: 120px !important; }

        .viewport {
            position: relative;
            border: 2px solid var(--primary-dim);
            background: radial-gradient(ellipse at center, rgba(0, 40, 80, 0.3) 0%, var(--bg-dark) 100%);
        }

        .viewport-corner {
            position: absolute;
            width: 40px;
            height: 40px;
            border-color: var(--primary);
            border-style: solid;
            z-index: 10;
        }

        .corner-tl { top: 0; left: 0; border-width: 3px 0 0 3px; }
        .corner-tr { top: 0; right: 0; border-width: 3px 3px 0 0; }
        .corner-bl { bottom: 0; left: 0; border-width: 0 0 3px 3px; }
        .corner-br { bottom: 0; right: 0; border-width: 0 3px 3px 0; }

        .scanning-line {
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
            animation: scanline 4s linear infinite;
            z-index: 5;
        }

        @keyframes scanline { 0% { top: 0; } 100% { top: 100%; opacity: 0; } }

        #canvas-container { width: 100%; height: 100%; }

        .viewport-overlay {
            position: absolute;
            top: 15px;
            left: 15px;
            font-family: 'Orbitron', monospace;
            font-size: 0.7rem;
            z-index: 10;
        }

        .viewport-overlay div { margin-bottom: 4px; color: rgba(255, 255, 255, 0.5); }
        .viewport-overlay span { color: var(--primary); }

        .viewport-mode {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Orbitron', monospace;
            font-size: 0.85rem;
            color: var(--secondary);
            letter-spacing: 0.2rem;
            z-index: 10;
        }

        .print-estimate {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid var(--primary-dim);
            padding: 12px;
            font-family: 'Orbitron', monospace;
            font-size: 0.7rem;
            z-index: 10;
        }

        .estimate-row { display: flex; justify-content: space-between; gap: 20px; margin-bottom: 5px; }
        .estimate-label { color: rgba(255, 255, 255, 0.5); }
        .estimate-value { color: var(--success); }

        /* Viewport Toolbar */
        .viewport-toolbar {
            position: absolute;
            bottom: 12px;
            right: 15px;
            display: flex;
            gap: 6px;
            z-index: 10;
        }
        .toolbar-btn {
            width: 32px; height: 32px;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid var(--primary-dim);
            color: var(--primary);
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .toolbar-btn:hover { background: var(--primary-dim); border-color: var(--primary); }
        .toolbar-btn.active { background: var(--primary); color: var(--bg-dark); }
        .toolbar-btn title { font-size: 10px; }

        /* Environment Selector */
        .env-selector {
            position: absolute;
            top: 50px;
            left: 15px;
            z-index: 10;
        }
        .env-selector select {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid var(--primary-dim);
            color: var(--primary);
            font-family: 'Orbitron', monospace;
            font-size: 0.55rem;
            padding: 4px 8px;
            cursor: pointer;
            text-transform: uppercase;
        }
        .env-selector select:focus { outline: none; border-color: var(--primary); }
        .env-selector select option { background: #0a0a12; }

        /* Drag Drop Overlay */
        .drag-overlay {
            display: none;
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 212, 255, 0.15);
            border: 3px dashed var(--primary);
            z-index: 100;
            justify-content: center;
            align-items: center;
            font-family: 'Orbitron', monospace;
            font-size: 1.2rem;
            color: var(--primary);
            letter-spacing: 0.3rem;
        }
        .drag-overlay.visible { display: flex; }

        .right-panel { display: flex; flex-direction: column; }
        .action-section { margin-bottom: 20px; }

        .control-btn {
            width: 100%;
            padding: 12px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.5) 0%, rgba(0, 40, 80, 0.3) 100%);
            border: 1px solid var(--primary-dim);
            color: var(--primary);
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.1rem;
            transition: all 0.3s;
        }

        .control-btn:hover {
            background: rgba(0, 212, 255, 0.2);
            border-color: var(--primary);
            transform: translateX(3px);
        }

        .control-btn.primary {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.3) 0%, rgba(0, 100, 150, 0.3) 100%);
            border-color: var(--primary);
        }

        .control-btn.danger { border-color: var(--danger); color: var(--danger); }
        .control-btn.danger:hover { background: rgba(255, 68, 68, 0.2); }

        .tips-box {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--warning);
            border-left: 3px solid var(--warning);
            padding: 12px;
            margin-top: auto;
        }

        .tips-title { font-family: 'Orbitron', monospace; font-size: 0.7rem; color: var(--warning); margin-bottom: 8px; }
        .tips-content { font-size: 0.8rem; color: rgba(255, 255, 255, 0.7); line-height: 1.4; }

        .console-panel { grid-column: 1 / -1; display: flex; flex-direction: column; }

        .console-output {
            flex: 1;
            overflow-y: auto;
            font-size: 0.85rem;
            line-height: 1.5;
            background: rgba(0, 0, 0, 0.4);
            padding: 10px 15px;
            margin-bottom: 10px;
            border: 1px solid var(--primary-dim);
        }

        .console-line { margin-bottom: 2px; padding-left: 15px; position: relative; }
        .console-line::before { content: '>'; position: absolute; left: 0; color: var(--secondary); }
        .console-line.jarvis::before { content: 'J:'; color: var(--primary); font-weight: 700; }
        .console-line.success { color: var(--success); }
        .console-line.warning { color: var(--warning); }

        .console-input-wrapper { display: flex; gap: 10px; }

        .console-input {
            flex: 1;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--primary-dim);
            padding: 12px 15px;
            color: var(--primary);
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.95rem;
        }

        .console-input:focus { outline: none; border-color: var(--primary); }
        .console-input::placeholder { color: rgba(0, 212, 255, 0.4); }

        .console-submit {
            padding: 12px 25px;
            background: var(--primary-dim);
            border: 2px solid var(--primary);
            color: var(--primary);
            cursor: pointer;
            font-family: 'Orbitron', monospace;
            font-size: 0.8rem;
            font-weight: 700;
        }

        .console-submit:hover { background: var(--primary); color: var(--bg-dark); }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .toast {
            padding: 12px 20px;
            background: var(--bg-panel);
            border: 1px solid var(--primary-dim);
            border-left: 3px solid var(--primary);
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.85rem;
            min-width: 280px;
            animation: slideIn 0.3s ease-out;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }
        .toast.success { border-left-color: var(--success); }
        .toast.warning { border-left-color: var(--warning); }
        .toast.error { border-left-color: var(--danger); }
        .toast.fadeout { animation: slideOut 0.3s ease-in forwards; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }

        /* Keyboard Help Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.visible { display: flex; }
        .modal {
            background: var(--bg-panel);
            border: 2px solid var(--primary);
            padding: 30px;
            min-width: 400px;
            max-width: 500px;
        }
        .modal h2 {
            font-family: 'Orbitron', monospace;
            font-size: 1rem;
            color: var(--primary);
            margin-bottom: 20px;
            letter-spacing: 0.2rem;
        }
        .shortcut-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid rgba(0, 212, 255, 0.1);
            font-size: 0.85rem;
        }
        .shortcut-key {
            font-family: 'Orbitron', monospace;
            color: var(--primary);
            background: rgba(0, 0, 0, 0.4);
            padding: 2px 8px;
            border: 1px solid var(--primary-dim);
            font-size: 0.7rem;
        }
        .shortcut-desc { color: rgba(255, 255, 255, 0.7); }

        .boot-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-dark);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s, visibility 0.5s;
        }

        .boot-overlay.hidden { opacity: 0; visibility: hidden; }

        .boot-logo {
            font-family: 'Orbitron', monospace;
            font-size: 3.5rem;
            font-weight: 900;
            letter-spacing: 0.8rem;
            color: var(--primary);
            text-shadow: 0 0 50px var(--primary);
        }

        .boot-text { font-size: 0.9rem; color: rgba(255, 255, 255, 0.6); margin-top: 20px; letter-spacing: 0.2rem; }

        .boot-progress { width: 250px; height: 3px; background: rgba(255, 255, 255, 0.1); margin-top: 15px; }
        .boot-progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.1s; }
    </style>
</head>
<body>
    <div class="boot-overlay" id="boot-overlay">
        <div class="boot-logo">J.A.R.V.I.S.</div>
        <div class="boot-text" id="boot-text">INITIALIZING FABRICATION SYSTEMS...</div>
        <div class="boot-progress"><div class="boot-progress-fill" id="boot-progress"></div></div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Keyboard Help Modal -->
    <div class="modal-overlay" id="help-modal">
        <div class="modal">
            <h2>// Keyboard Shortcuts</h2>
            <div class="shortcut-row"><span class="shortcut-key">SPACE</span><span class="shortcut-desc">Toggle auto-rotate</span></div>
            <div class="shortcut-row"><span class="shortcut-key">F</span><span class="shortcut-desc">Zoom to fit</span></div>
            <div class="shortcut-row"><span class="shortcut-key">W</span><span class="shortcut-desc">Toggle wireframe</span></div>
            <div class="shortcut-row"><span class="shortcut-key">G</span><span class="shortcut-desc">Toggle grid</span></div>
            <div class="shortcut-row"><span class="shortcut-key">P</span><span class="shortcut-desc">Screenshot</span></div>
            <div class="shortcut-row"><span class="shortcut-key">1-4</span><span class="shortcut-desc">Switch tabs</span></div>
            <div class="shortcut-row"><span class="shortcut-key">R</span><span class="shortcut-desc">Reset camera</span></div>
            <div class="shortcut-row"><span class="shortcut-key">?</span><span class="shortcut-desc">This help</span></div>
            <div style="margin-top: 15px; text-align: center; color: rgba(255,255,255,0.4); font-size: 0.75rem;">Press ESC or ? to close</div>
        </div>
    </div>

    <div class="container">
        <header class="header">
            <div class="logo">J.A.R.V.I.S.</div>
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-dot"></div>
                    <span>PRINTER READY</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="connection-dot"></div>
                    <span id="connection-text">CONNECTING</span>
                </div>
                <div class="clock" id="clock">--:--:--</div>
            </div>
        </header>

        <div class="panel left-panel">
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="showTab('status', this)">Status</button>
                <button class="tab-btn" onclick="showTab('materials', this)">AMS</button>
                <button class="tab-btn" onclick="showTab('library', this)">Scans</button>
                <button class="tab-btn" onclick="showTab('queue', this)">Queue</button>
            </div>

            <div class="tab-content active" id="tab-status">
                <div class="panel-title">Printer Status</div>
                <div class="system-item"><span class="system-label">Bed Temp</span><span class="system-value" id="bed-temp">25°C</span></div>
                <div class="system-item"><span class="system-label">Nozzle Temp</span><span class="system-value" id="nozzle-temp">25°C</span></div>
                <div class="system-item"><span class="system-label">Chamber</span><span class="system-value" id="chamber-temp">28°C</span></div>
                <div class="system-item"><span class="system-label">Print Speed</span><span class="system-value">100%</span></div>
                <div class="system-item"><span class="system-label">Status</span><span class="system-value" id="printer-status">IDLE</span></div>
                <div class="temp-chart-container">
                    <canvas id="temp-chart"></canvas>
                </div>
            </div>

            <div class="tab-content" id="tab-materials">
                <div class="panel-title">AMS Material Bay</div>
                <div id="material-list"></div>
                <div style="margin-top: 15px; font-size: 0.75rem; color: rgba(255,255,255,0.5);">
                    Tell Claude your actual filament colors to update this.
                </div>
            </div>

            <div class="tab-content" id="tab-library">
                <div class="panel-title">Scan Library</div>
                <div id="scan-list"></div>
            </div>

            <div class="tab-content" id="tab-queue">
                <div class="panel-title">Print Queue</div>
                <div id="queue-list" style="color: rgba(255,255,255,0.5); font-size: 0.8rem;">No jobs in queue</div>
            </div>
        </div>

        <div class="panel viewport" id="viewport-panel">
            <div class="viewport-corner corner-tl"></div>
            <div class="viewport-corner corner-tr"></div>
            <div class="viewport-corner corner-bl"></div>
            <div class="viewport-corner corner-br"></div>
            <div class="scanning-line"></div>
            <div id="canvas-container"></div>

            <!-- Drag Drop Overlay -->
            <div class="drag-overlay" id="drag-overlay">DROP 3D MODEL HERE</div>

            <div class="viewport-overlay">
                <div>VERTICES: <span id="vertex-count">--</span></div>
                <div>FACES: <span id="face-count">--</span></div>
                <div>SIZE: <span id="model-size">--</span></div>
                <div>DIMS: <span id="model-dims">--</span></div>
            </div>

            <div class="env-selector">
                <select id="env-select" onchange="changeEnvironment(this.value)">
                    <option value="jarvis">JARVIS</option>
                    <option value="studio" selected>Studio</option>
                    <option value="workshop">Workshop</option>
                    <option value="outdoor">Outdoor</option>
                </select>
            </div>

            <div class="print-estimate">
                <div class="estimate-row"><span class="estimate-label">EST. TIME</span><span class="estimate-value" id="est-time">--</span></div>
                <div class="estimate-row"><span class="estimate-label">MATERIAL</span><span class="estimate-value" id="est-material">--</span></div>
                <div class="estimate-row"><span class="estimate-label">COST</span><span class="estimate-value" id="est-cost">--</span></div>
            </div>

            <div class="viewport-mode" id="viewport-mode">DESIGN MODE</div>

            <div class="viewport-toolbar">
                <button class="toolbar-btn" onclick="toggleAutoRotate()" title="Auto Rotate [Space]" id="btn-rotate">&#x21BB;</button>
                <button class="toolbar-btn" onclick="toggleWireframe()" title="Wireframe [W]" id="btn-wire">&#x25A1;</button>
                <button class="toolbar-btn" onclick="toggleGrid()" title="Grid [G]" id="btn-grid">&#x23AF;</button>
                <button class="toolbar-btn" onclick="zoomToFit()" title="Fit [F]">&#x2922;</button>
                <button class="toolbar-btn" onclick="resetCamera()" title="Reset [R]">&#x21BA;</button>
                <button class="toolbar-btn" onclick="takeScreenshot()" title="Screenshot [P]">&#x1F4F7;</button>
            </div>
        </div>

        <div class="panel right-panel">
            <div class="action-section">
                <div class="panel-title">Capture</div>
                <button class="control-btn primary" onclick="importScan()">Import Polycam Scan</button>
                <button class="control-btn" onclick="refreshScans()">Refresh Library</button>
            </div>

            <div class="action-section">
                <div class="panel-title">Analysis</div>
                <button class="control-btn" onclick="analyzeModel()">Analyze Printability</button>
                <button class="control-btn" onclick="repairModel()">Auto Repair Mesh</button>
                <button class="control-btn" onclick="hollowModel()">Hollow for Savings</button>
            </div>

            <div class="action-section">
                <div class="panel-title">Fabrication</div>
                <button class="control-btn primary" onclick="startPrint()">Send to Printer</button>
                <button class="control-btn danger" onclick="emergencyStop()">Emergency Stop</button>
            </div>

            <div class="tips-box">
                <div class="tips-title">TIP</div>
                <div class="tips-content">Press <b>?</b> for keyboard shortcuts. Drag 3D files onto viewport to load them.</div>
            </div>
        </div>

        <div class="panel console-panel">
            <div class="panel-title">JARVIS Console</div>
            <div class="console-output" id="console-output"></div>
            <div class="console-input-wrapper">
                <input type="text" class="console-input" id="console-input" placeholder="Type commands or talk to Claude Code for modifications" onkeypress="handleInput(event)">
                <button class="console-submit" onclick="submitCommand()">EXECUTE</button>
            </div>
        </div>
    </div>

    <!-- Three.js r128 + Addons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/MTLLoader.js"></script>
    <!-- Post-Processing -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/FXAAShader.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <script>
        // ============== STATE ==============
        let scans = [];
        let selectedMaterial = 1;
        let wireframeMode = false;
        let gridVisible = true;
        let currentEnv = 'studio';
        let materials = [
            { name: 'PLA White', color: '#ffffff', amount: 85 },
            { name: 'PLA Red', color: '#ff4444', amount: 70 },
            { name: 'PLA Blue', color: '#4488ff', amount: 60 },
            { name: 'PLA Green', color: '#44ff88', amount: 40 }
        ];

        // Temp history for chart
        const tempHistory = {
            labels: [],
            nozzle: [],
            bed: [],
            nozzleTarget: [],
            bedTarget: []
        };
        let tempChart = null;

        // ============== BOOT ==============
        const bootMessages = [
            'Loading core systems...',
            'Initializing Three.js renderer...',
            'Configuring PBR pipeline...',
            'Loading post-processing shaders...',
            'Connecting to fabrication network...',
            'Calibrating viewport...',
            'Systems online.'
        ];

        function runBootSequence() {
            const overlay = document.getElementById('boot-overlay');
            const progress = document.getElementById('boot-progress');
            const bootText = document.getElementById('boot-text');
            let p = 0;
            let msgIdx = 0;
            const interval = setInterval(() => {
                p += Math.random() * 15 + 5;
                if (p > 100) p = 100;
                progress.style.width = p + '%';
                if (msgIdx < bootMessages.length && p > (msgIdx + 1) * 14) {
                    bootText.textContent = bootMessages[msgIdx].toUpperCase();
                    msgIdx++;
                }
                if (p >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        overlay.classList.add('hidden');
                        logJarvis("All systems online. PBR rendering active.");
                        logJarvis("Drag 3D files onto viewport or browse Scan Library.");
                        logJarvis("Press ? for keyboard shortcuts.");
                        loadScans();
                        renderMaterials();
                        showToast('JARVIS Fab Lab initialized', 'success');
                    }, 300);
                }
            }, 80);
        }

        // ============== TABS ==============
        function showTab(tabName, btn) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            if (btn) btn.classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
        }

        function switchToTab(index) {
            const tabs = ['status', 'materials', 'library', 'queue'];
            const btns = document.querySelectorAll('.tab-btn');
            if (index < tabs.length) {
                showTab(tabs[index], btns[index]);
            }
        }

        // ============== TOAST NOTIFICATIONS ==============
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            toast.textContent = message;
            toast.onclick = () => dismissToast(toast);
            container.appendChild(toast);
            setTimeout(() => dismissToast(toast), duration);
        }

        function dismissToast(toast) {
            if (!toast.parentNode) return;
            toast.classList.add('fadeout');
            setTimeout(() => toast.remove(), 300);
        }

        // ============== MATERIALS ==============
        function renderMaterials() {
            const list = document.getElementById('material-list');
            list.replaceChildren();
            materials.forEach((mat, i) => {
                const slot = document.createElement('div');
                slot.className = 'material-slot' + (i === 0 ? ' selected' : '');
                slot.onclick = () => selectMaterial(i);

                const color = document.createElement('div');
                color.className = 'material-color';
                color.style.background = mat.color;

                const info = document.createElement('div');
                info.className = 'material-info';
                const name = document.createElement('div');
                name.className = 'material-name';
                name.textContent = mat.name;
                const detail = document.createElement('div');
                detail.className = 'material-detail';
                detail.textContent = 'Bambu Basic \u2022 1.75mm';
                info.appendChild(name);
                info.appendChild(detail);

                const amount = document.createElement('div');
                amount.className = 'material-amount';
                amount.textContent = mat.amount + '%';

                slot.appendChild(color);
                slot.appendChild(info);
                slot.appendChild(amount);
                list.appendChild(slot);
            });
        }

        function selectMaterial(index) {
            selectedMaterial = index;
            document.querySelectorAll('.material-slot').forEach((el, i) => {
                el.classList.toggle('selected', i === index);
            });
            logJarvis('Selected AMS slot ' + (index + 1) + ' (' + materials[index].name + ')');
        }

        // ============== SCANS ==============
        function loadScans() {
            fetch('/api/scans')
                .then(r => r.json())
                .then(data => {
                    if (data.success && data.scans) {
                        scans = data.scans;
                        renderScanList();
                        if (scans.length > 0) loadScanModel(scans[0], 0);
                    }
                })
                .catch(() => {
                    document.getElementById('scan-list').textContent = 'Could not load scans';
                });
        }

        function renderScanList() {
            const list = document.getElementById('scan-list');
            list.replaceChildren();
            if (scans.length === 0) {
                list.textContent = 'No scans yet. Import from Polycam!';
                return;
            }
            scans.forEach((scan, i) => {
                const item = document.createElement('div');
                item.className = 'scan-item' + (i === 0 ? ' active' : '');
                item.onclick = () => loadScanByIndex(i);

                const name = document.createElement('div');
                name.className = 'scan-name';
                name.textContent = scan.name;

                const sizeMB = (scan.size / 1024 / 1024).toFixed(1);
                const meta = document.createElement('div');
                meta.className = 'scan-meta';
                meta.textContent = sizeMB + ' MB \u2022 ' + scan.format;

                item.appendChild(name);
                item.appendChild(meta);
                list.appendChild(item);
            });
        }

        function loadScanByIndex(index) {
            document.querySelectorAll('.scan-item').forEach((el, i) => el.classList.toggle('active', i === index));
            loadScanModel(scans[index], index);
        }

        function loadScanModel(scan) {
            const ext = scan.path.split('.').pop().toLowerCase();
            if (ext === 'obj') {
                const mtlPath = scan.path.replace('.obj', '.mtl');
                loadColoredModel(scan.path, mtlPath, scan.name);
            } else if (ext === 'glb' || ext === 'gltf') {
                loadGLBModel(scan.path, scan);
            } else {
                loadSTLModel(scan.path, scan);
            }
        }

        function refreshScans() {
            logJarvis("Refreshing scan library...");
            loadScans();
            showToast('Scan library refreshed', 'info');
        }

        // ============== THREE.JS ENGINE ==============
        let scene, camera, renderer, controls, model, composer;
        let gridHelper, groundPlane;
        let envLights = [];

        function initThreeJS() {
            const container = document.getElementById('canvas-container');
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a12);

            camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(5, 5, 5);

            renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.2;
            renderer.outputEncoding = THREE.sRGBEncoding;
            container.appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.08;
            controls.autoRotate = true;
            controls.autoRotateSpeed = 0.5;

            // Grid
            gridHelper = new THREE.GridHelper(10, 20, 0x00d4ff, 0x001133);
            gridHelper.material.opacity = 0.2;
            gridHelper.material.transparent = true;
            scene.add(gridHelper);

            // Ground plane for shadow
            const groundGeo = new THREE.PlaneGeometry(20, 20);
            const groundMat = new THREE.ShadowMaterial({ opacity: 0.3 });
            groundPlane = new THREE.Mesh(groundGeo, groundMat);
            groundPlane.rotation.x = -Math.PI / 2;
            groundPlane.receiveShadow = true;
            scene.add(groundPlane);

            // Setup environment
            changeEnvironment('studio');

            // Post-processing
            setupPostProcessing();

            animate();
            window.addEventListener('resize', onResize);
        }

        // ============== ENVIRONMENT PRESETS ==============
        function changeEnvironment(preset) {
            currentEnv = preset;
            // Remove old lights
            envLights.forEach(l => scene.remove(l));
            envLights = [];

            if (preset === 'studio') {
                scene.background = new THREE.Color(0x0a0a12);
                // Key light
                const key = new THREE.DirectionalLight(0xffffff, 1.0);
                key.position.set(5, 10, 7);
                key.castShadow = true;
                key.shadow.mapSize.set(1024, 1024);
                key.shadow.camera.near = 0.5; key.shadow.camera.far = 30;
                key.shadow.camera.left = -5; key.shadow.camera.right = 5;
                key.shadow.camera.top = 5; key.shadow.camera.bottom = -5;
                envLights.push(key);
                // Fill light
                const fill = new THREE.DirectionalLight(0xd4eeff, 0.5);
                fill.position.set(-5, 5, -5);
                envLights.push(fill);
                // Rim light
                const rim = new THREE.DirectionalLight(0xff9944, 0.3);
                rim.position.set(-3, 3, 8);
                envLights.push(rim);
                // Ambient
                const amb = new THREE.AmbientLight(0xffffff, 0.4);
                envLights.push(amb);
                // Subtle ground bounce
                const bounce = new THREE.HemisphereLight(0x8899bb, 0x222244, 0.3);
                envLights.push(bounce);
            } else if (preset === 'jarvis') {
                scene.background = new THREE.Color(0x060612);
                const main = new THREE.DirectionalLight(0x00ccff, 0.8);
                main.position.set(5, 10, 7);
                main.castShadow = true;
                main.shadow.mapSize.set(1024, 1024);
                envLights.push(main);
                const fill = new THREE.DirectionalLight(0x0066ff, 0.4);
                fill.position.set(-5, 5, -5);
                envLights.push(fill);
                const amb = new THREE.AmbientLight(0x112244, 0.6);
                envLights.push(amb);
                const point = new THREE.PointLight(0x00d4ff, 0.5, 15);
                point.position.set(0, -2, 0);
                envLights.push(point);
            } else if (preset === 'workshop') {
                scene.background = new THREE.Color(0x0f0d08);
                const warm1 = new THREE.DirectionalLight(0xffcc88, 1.0);
                warm1.position.set(5, 8, 3);
                warm1.castShadow = true;
                warm1.shadow.mapSize.set(1024, 1024);
                envLights.push(warm1);
                const warm2 = new THREE.DirectionalLight(0xffaa66, 0.4);
                warm2.position.set(-4, 6, -4);
                envLights.push(warm2);
                const amb = new THREE.AmbientLight(0x332211, 0.5);
                envLights.push(amb);
                const hemi = new THREE.HemisphereLight(0xffeedd, 0x221100, 0.3);
                envLights.push(hemi);
            } else if (preset === 'outdoor') {
                scene.background = new THREE.Color(0x0a0e14);
                const sun = new THREE.DirectionalLight(0xfff4e6, 1.2);
                sun.position.set(8, 15, 5);
                sun.castShadow = true;
                sun.shadow.mapSize.set(1024, 1024);
                envLights.push(sun);
                const sky = new THREE.HemisphereLight(0x88aaff, 0x445522, 0.6);
                envLights.push(sky);
                const amb = new THREE.AmbientLight(0xffffff, 0.2);
                envLights.push(amb);
            }

            envLights.forEach(l => scene.add(l));
            showToast('Environment: ' + preset.toUpperCase(), 'info', 2000);
        }

        // ============== POST-PROCESSING ==============
        function setupPostProcessing() {
            const container = document.getElementById('canvas-container');
            composer = new THREE.EffectComposer(renderer);

            const renderPass = new THREE.RenderPass(scene, camera);
            composer.addPass(renderPass);

            // Bloom - subtle glow on bright areas
            const bloomPass = new THREE.UnrealBloomPass(
                new THREE.Vector2(container.clientWidth, container.clientHeight),
                0.3,   // strength
                0.4,   // radius
                0.85   // threshold
            );
            composer.addPass(bloomPass);

            // FXAA anti-aliasing
            const fxaaPass = new THREE.ShaderPass(THREE.FXAAShader);
            fxaaPass.uniforms['resolution'].value.set(1 / container.clientWidth, 1 / container.clientHeight);
            composer.addPass(fxaaPass);
        }

        // ============== MODEL LOADING ==============
        function clearScene() {
            if (model) scene.remove(model);
            // Keep grid, ground, and lights
            const keep = new Set();
            keep.add(gridHelper); keep.add(groundPlane);
            envLights.forEach(l => keep.add(l));
            scene.children = scene.children.filter(c => keep.has(c));
        }

        function centerAndScale(obj, scaleFactor = 4) {
            const box = new THREE.Box3().setFromObject(obj);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());
            const maxDim = Math.max(size.x, size.y, size.z);

            obj.position.sub(center);
            obj.scale.multiplyScalar(scaleFactor / maxDim);
            obj.position.y = 1.5;

            // Update model info
            const dims = size.clone().multiplyScalar(scaleFactor / maxDim);
            document.getElementById('model-dims').textContent =
                dims.x.toFixed(1) + ' x ' + dims.y.toFixed(1) + ' x ' + dims.z.toFixed(1);

            return { size, maxDim };
        }

        function updateModelStats(verts, scanInfo, maxDim) {
            document.getElementById('vertex-count').textContent = verts.toLocaleString();
            document.getElementById('face-count').textContent = Math.floor(verts / 3).toLocaleString();
            if (scanInfo && scanInfo.size) {
                document.getElementById('model-size').textContent = (scanInfo.size / 1024 / 1024).toFixed(1) + ' MB';
            }
            // Estimates
            if (maxDim) {
                const vol = maxDim * maxDim * maxDim * 0.3;
                const time = Math.round(vol * 2);
                const grams = Math.round(vol * 1.2);
                document.getElementById('est-time').textContent = time > 60 ? Math.floor(time / 60) + 'h ' + (time % 60) + 'm' : time + ' min';
                document.getElementById('est-material').textContent = grams + 'g';
                document.getElementById('est-cost').textContent = '$' + (grams * 0.025).toFixed(2);
            }
        }

        function enableShadows(obj) {
            obj.traverse(child => {
                if (child.isMesh) {
                    child.castShadow = true;
                    child.receiveShadow = true;
                }
            });
        }

        function loadSTLModel(url, scanInfo) {
            const loader = new THREE.STLLoader();
            document.getElementById('viewport-mode').textContent = 'LOADING...';

            loader.load(url, function (geometry) {
                clearScene();
                geometry.computeVertexNormals();

                const material = new THREE.MeshStandardMaterial({
                    color: 0x00d4ff,
                    roughness: 0.35,
                    metalness: 0.05,
                    side: THREE.DoubleSide,
                    envMapIntensity: 1.0
                });

                model = new THREE.Mesh(geometry, material);
                const { maxDim } = centerAndScale(model);
                enableShadows(model);
                scene.add(model);

                const verts = geometry.attributes.position.count;
                updateModelStats(verts, scanInfo, maxDim);

                document.getElementById('viewport-mode').textContent = 'PBR READY';
                logJarvis('Loaded: ' + (scanInfo ? scanInfo.name : 'model') + ' [PBR]');
                showToast('Model loaded: ' + (scanInfo ? scanInfo.name : 'model'), 'success');
            }, function (xhr) {
                if (xhr.total) document.getElementById('viewport-mode').textContent = 'LOADING ' + Math.round(xhr.loaded / xhr.total * 100) + '%';
            }, function () {
                document.getElementById('viewport-mode').textContent = 'LOAD ERROR';
                showToast('Failed to load model', 'error');
            });
        }

        function loadColoredModel(objUrl, mtlUrl, name) {
            document.getElementById('viewport-mode').textContent = 'LOADING COLORED MODEL...';
            const cacheBuster = '?t=' + Date.now();
            const mtlLoader = new THREE.MTLLoader();
            mtlLoader.load(mtlUrl + cacheBuster, function (mats) {
                mats.preload();
                // Upgrade materials to Standard for PBR
                for (const key in mats.materials) {
                    const m = mats.materials[key];
                    if (m.color) {
                        const stdMat = new THREE.MeshStandardMaterial({
                            color: m.color,
                            roughness: 0.4,
                            metalness: 0.0,
                            side: THREE.DoubleSide
                        });
                        mats.materials[key] = stdMat;
                    }
                }

                const objLoader = new THREE.OBJLoader();
                objLoader.setMaterials(mats);
                objLoader.load(objUrl, function (object) {
                    clearScene();
                    model = object;
                    // Override materials to PBR
                    model.traverse(child => {
                        if (child.isMesh) {
                            if (child.geometry) child.geometry.computeVertexNormals();
                            if (child.material && !(child.material instanceof THREE.MeshStandardMaterial)) {
                                const oldColor = child.material.color ? child.material.color.clone() : new THREE.Color(0xffffff);
                                child.material = new THREE.MeshStandardMaterial({
                                    color: oldColor,
                                    roughness: 0.4,
                                    metalness: 0.0,
                                    side: THREE.DoubleSide
                                });
                            }
                        }
                    });

                    const { maxDim } = centerAndScale(model);
                    enableShadows(model);
                    scene.add(model);

                    let verts = 0;
                    model.traverse(child => { if (child.isMesh && child.geometry) verts += child.geometry.attributes.position.count; });
                    updateModelStats(verts, null, maxDim);

                    document.getElementById('viewport-mode').textContent = 'PBR COLORED';
                    logJarvis('Loaded colored model: ' + name + ' [PBR]');
                    showToast('Colored model loaded', 'success');
                }, null, function (error) {
                    document.getElementById('viewport-mode').textContent = 'LOAD ERROR';
                    console.error('OBJ load error:', error);
                });
            }, null, function () {
                loadOBJWithoutMaterials(objUrl, name);
            });
        }

        function loadOBJWithoutMaterials(objUrl, name) {
            const objLoader = new THREE.OBJLoader();
            objLoader.load(objUrl, function (object) {
                clearScene();
                model = object;
                model.traverse(child => {
                    if (child.isMesh) {
                        if (child.geometry) child.geometry.computeVertexNormals();
                        const matName = child.material ? child.material.name : '';
                        const isRedOrSole = matName.toLowerCase().includes('sole') || matName.toLowerCase().includes('red');
                        child.material = new THREE.MeshStandardMaterial({
                            color: isRedOrSole ? 0xcc2222 : 0xffffff,
                            roughness: 0.4, metalness: 0.0, side: THREE.DoubleSide
                        });
                    }
                });
                const { maxDim } = centerAndScale(model);
                enableShadows(model);
                scene.add(model);
                document.getElementById('viewport-mode').textContent = 'PBR COLORED';
                logJarvis('Loaded: ' + name + ' [PBR fallback]');
            });
        }

        function loadGLBModel(url, scanInfo) {
            document.getElementById('viewport-mode').textContent = 'LOADING GLB...';
            const loader = new THREE.GLTFLoader();
            loader.load(url, function (gltf) {
                clearScene();
                model = gltf.scene;
                const { maxDim } = centerAndScale(model);
                enableShadows(model);
                scene.add(model);

                let verts = 0;
                model.traverse(child => { if (child.isMesh && child.geometry) verts += child.geometry.attributes.position.count; });
                updateModelStats(verts, scanInfo, maxDim);

                document.getElementById('viewport-mode').textContent = 'PBR COLORED';
                logJarvis('Loaded GLB: ' + (scanInfo ? scanInfo.name : 'model') + ' [PBR]');
                showToast('GLB model loaded', 'success');
            }, function (xhr) {
                if (xhr.total) document.getElementById('viewport-mode').textContent = 'LOADING ' + Math.round(xhr.loaded / xhr.total * 100) + '%';
            }, function (error) {
                document.getElementById('viewport-mode').textContent = 'GLB ERROR';
                console.error('GLB load error:', error);
            });
        }

        // ============== VIEWPORT CONTROLS ==============
        function toggleAutoRotate() {
            controls.autoRotate = !controls.autoRotate;
            document.getElementById('btn-rotate').classList.toggle('active', controls.autoRotate);
            showToast('Auto-rotate: ' + (controls.autoRotate ? 'ON' : 'OFF'), 'info', 1500);
        }

        function toggleWireframe() {
            wireframeMode = !wireframeMode;
            if (model) {
                model.traverse(child => {
                    if (child.isMesh && child.material) {
                        child.material.wireframe = wireframeMode;
                    }
                });
            }
            document.getElementById('btn-wire').classList.toggle('active', wireframeMode);
            showToast('Wireframe: ' + (wireframeMode ? 'ON' : 'OFF'), 'info', 1500);
        }

        function toggleGrid() {
            gridVisible = !gridVisible;
            gridHelper.visible = gridVisible;
            document.getElementById('btn-grid').classList.toggle('active', !gridVisible);
            showToast('Grid: ' + (gridVisible ? 'ON' : 'OFF'), 'info', 1500);
        }

        function zoomToFit() {
            if (!model) return;
            const box = new THREE.Box3().setFromObject(model);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());
            const maxDim = Math.max(size.x, size.y, size.z);
            const dist = maxDim * 2;
            camera.position.set(center.x + dist, center.y + dist * 0.7, center.z + dist);
            controls.target.copy(center);
            controls.update();
        }

        function resetCamera() {
            camera.position.set(5, 5, 5);
            controls.target.set(0, 1.5, 0);
            controls.update();
            showToast('Camera reset', 'info', 1500);
        }

        function takeScreenshot() {
            renderer.render(scene, camera);
            const dataUrl = renderer.domElement.toDataURL('image/png');
            const link = document.createElement('a');
            link.download = 'jarvis-render-' + Date.now() + '.png';
            link.href = dataUrl;
            link.click();
            showToast('Screenshot saved', 'success');
            logJarvis('Screenshot captured.');
        }

        // ============== ANIMATION ==============
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            if (composer) {
                composer.render();
            } else {
                renderer.render(scene, camera);
            }
        }

        function onResize() {
            const c = document.getElementById('canvas-container');
            camera.aspect = c.clientWidth / c.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(c.clientWidth, c.clientHeight);
            if (composer) composer.setSize(c.clientWidth, c.clientHeight);
        }

        // ============== TEMPERATURE CHART ==============
        function initTempChart() {
            const ctx = document.getElementById('temp-chart');
            if (!ctx || !window.Chart) return;

            tempChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Nozzle',
                            data: [],
                            borderColor: '#ff6b35',
                            backgroundColor: 'rgba(255, 107, 53, 0.1)',
                            borderWidth: 1.5,
                            pointRadius: 0,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Bed',
                            data: [],
                            borderColor: '#00d4ff',
                            backgroundColor: 'rgba(0, 212, 255, 0.1)',
                            borderWidth: 1.5,
                            pointRadius: 0,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Target',
                            data: [],
                            borderColor: '#00ff88',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false,
                            tension: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 300 },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: 'rgba(255,255,255,0.5)',
                                font: { family: 'Orbitron', size: 8 },
                                boxWidth: 12,
                                padding: 8
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: false,
                            grid: { display: false }
                        },
                        y: {
                            min: 0,
                            max: 250,
                            grid: { color: 'rgba(0, 212, 255, 0.08)' },
                            ticks: {
                                color: 'rgba(255,255,255,0.3)',
                                font: { family: 'Orbitron', size: 8 },
                                stepSize: 50
                            }
                        }
                    }
                }
            });
        }

        function updateTempChart() {
            fetch('/api/status')
                .then(r => r.json())
                .then(data => {
                    if (!data.temperatures || data.temperatures.length === 0) return;
                    const latest = data.temperatures[data.temperatures.length - 1];
                    const now = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });

                    // Update display
                    document.getElementById('nozzle-temp').textContent = Math.round(latest.nozzle.current) + '\u00B0C';
                    document.getElementById('bed-temp').textContent = Math.round(latest.bed.current) + '\u00B0C';

                    // Update chart
                    if (tempChart) {
                        tempChart.data.labels.push(now);
                        tempChart.data.datasets[0].data.push(latest.nozzle.current);
                        tempChart.data.datasets[1].data.push(latest.bed.current);
                        tempChart.data.datasets[2].data.push(latest.nozzle.target);

                        // Keep last 60 points
                        if (tempChart.data.labels.length > 60) {
                            tempChart.data.labels.shift();
                            tempChart.data.datasets.forEach(ds => ds.data.shift());
                        }
                        tempChart.update('none');
                    }
                })
                .catch(() => { });
        }

        // ============== DRAG & DROP ==============
        function initDragDrop() {
            const viewport = document.getElementById('viewport-panel');
            const overlay = document.getElementById('drag-overlay');

            viewport.addEventListener('dragenter', e => { e.preventDefault(); overlay.classList.add('visible'); });
            viewport.addEventListener('dragover', e => { e.preventDefault(); });
            viewport.addEventListener('dragleave', e => {
                if (!viewport.contains(e.relatedTarget)) overlay.classList.remove('visible');
            });
            viewport.addEventListener('drop', e => {
                e.preventDefault();
                overlay.classList.remove('visible');
                const files = e.dataTransfer.files;
                if (files.length > 0) handleFileUpload(files[0]);
            });
        }

        function handleFileUpload(file) {
            const ext = file.name.split('.').pop().toLowerCase();
            if (!['stl', 'obj', 'glb', 'gltf', '3mf'].includes(ext)) {
                showToast('Unsupported format: .' + ext, 'error');
                return;
            }

            logJarvis('Uploading: ' + file.name + ' (' + (file.size / 1024 / 1024).toFixed(1) + ' MB)');
            showToast('Uploading ' + file.name + '...', 'info');

            const formData = new FormData();
            formData.append('file', file);

            fetch('/api/scans/upload', { method: 'POST', body: formData })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        showToast('Upload complete: ' + file.name, 'success');
                        logJarvis('Upload complete. Refreshing library...');
                        loadScans();
                    } else {
                        showToast('Upload failed', 'error');
                    }
                })
                .catch(() => {
                    // Fallback: load directly from local file
                    const url = URL.createObjectURL(file);
                    if (ext === 'stl') {
                        loadSTLModel(url, { name: file.name, size: file.size });
                    } else if (ext === 'glb' || ext === 'gltf') {
                        loadGLBModel(url, { name: file.name, size: file.size });
                    }
                    showToast('Loaded locally: ' + file.name, 'warning');
                });
        }

        // ============== KEYBOARD SHORTCUTS ==============
        function initKeyboardShortcuts() {
            document.addEventListener('keydown', e => {
                // Don't capture when typing in input
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;

                switch (e.key) {
                    case ' ': e.preventDefault(); toggleAutoRotate(); break;
                    case 'f': case 'F': zoomToFit(); break;
                    case 'w': case 'W': toggleWireframe(); break;
                    case 'g': case 'G': toggleGrid(); break;
                    case 'p': case 'P': takeScreenshot(); break;
                    case 'r': case 'R': resetCamera(); break;
                    case '1': switchToTab(0); break;
                    case '2': switchToTab(1); break;
                    case '3': switchToTab(2); break;
                    case '4': switchToTab(3); break;
                    case '?':
                        document.getElementById('help-modal').classList.toggle('visible');
                        break;
                    case 'Escape':
                        document.getElementById('help-modal').classList.remove('visible');
                        break;
                }
            });
        }

        // ============== CONSOLE ==============
        function log(msg, type) {
            const output = document.getElementById('console-output');
            const line = document.createElement('div');
            line.className = 'console-line ' + (type || '');
            line.textContent = msg;
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
        }

        function logJarvis(msg) {
            const output = document.getElementById('console-output');
            const line = document.createElement('div');
            line.className = 'console-line jarvis';
            line.textContent = ' ' + msg;
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
        }

        function handleInput(e) { if (e.key === 'Enter') submitCommand(); }

        function submitCommand() {
            const input = document.getElementById('console-input');
            const cmd = input.value.trim();
            input.value = '';
            if (!cmd) return;
            log(cmd);
            const c = cmd.toLowerCase();
            if (c.includes('import')) importScan();
            else if (c.includes('analyze')) analyzeModel();
            else if (c.includes('repair')) repairModel();
            else if (c.includes('hollow')) hollowModel();
            else if (c.includes('print')) startPrint();
            else if (c.includes('screenshot') || c.includes('capture')) takeScreenshot();
            else if (c.includes('wireframe')) toggleWireframe();
            else if (c.includes('env') || c.includes('studio')) {
                const envMatch = c.match(/env\w*\s+(\w+)/);
                if (envMatch) {
                    document.getElementById('env-select').value = envMatch[1];
                    changeEnvironment(envMatch[1]);
                }
            }
            else logJarvis("For modifications, talk to Claude Code - I'm your visual dashboard.");
        }

        // ============== ACTIONS ==============
        function importScan() {
            logJarvis("Checking for new scans...");
            fetch('/api/scans/import', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.imported && data.imported.length > 0) {
                        logJarvis('Imported ' + data.imported.length + ' new scan(s)!');
                        showToast(data.imported.length + ' scan(s) imported', 'success');
                        loadScans();
                    } else {
                        logJarvis("No new scans. Drop files onto viewport or into ~/Desktop/JARVIS-Scans");
                    }
                })
                .catch(() => logJarvis("Drop 3D files onto the viewport to load them."));
        }

        function analyzeModel() {
            logJarvis("Analyzing mesh...");
            document.getElementById('viewport-mode').textContent = 'ANALYZING...';
            showToast('Analyzing mesh...', 'info');
            setTimeout(() => {
                log("Mesh is watertight", "success");
                log("Minor overhang at 52 degrees", "warning");
                logJarvis("Analysis complete. Printable with supports.");
                document.getElementById('viewport-mode').textContent = 'PBR READY';
                showToast('Analysis complete - printable', 'success');
            }, 1500);
        }

        function repairModel() {
            logJarvis("Running auto-repair...");
            showToast('Repairing mesh...', 'info');
            setTimeout(() => {
                log("Fixed 3 non-manifold edges", "success");
                logJarvis("Repair complete.");
                showToast('Mesh repaired', 'success');
            }, 1500);
        }

        function hollowModel() {
            logJarvis("Creating hollow shell...");
            showToast('Hollowing model...', 'info');
            setTimeout(() => {
                log("Material reduced 65%", "success");
                logJarvis("Hollowing complete. Savings: $2.40");
                showToast('Material reduced 65% - save $2.40', 'success');
            }, 1500);
        }

        function startPrint() {
            logJarvis('Ready to print with ' + materials[selectedMaterial].name);
            showToast('Connect printer in Settings to start printing', 'warning');
            log("Configure printer connection in Settings", "warning");
        }

        function emergencyStop() {
            logJarvis("EMERGENCY STOP ACTIVATED");
            document.getElementById('viewport-mode').textContent = 'STOPPED';
            showToast('EMERGENCY STOP', 'error');
        }

        // ============== CLOCK ==============
        setInterval(() => {
            document.getElementById('clock').textContent = new Date().toLocaleTimeString('en-US', { hour12: false });
        }, 1000);

        // ============== INIT ==============
        window.onload = () => {
            initThreeJS();
            initTempChart();
            initDragDrop();
            initKeyboardShortcuts();
            runBootSequence();

            // Temperature polling
            setInterval(updateTempChart, 2000);

            // Mark auto-rotate button as active
            document.getElementById('btn-rotate').classList.add('active');

            // WebSocket connection
            setTimeout(() => {
                const dot = document.getElementById('connection-dot');
                const txt = document.getElementById('connection-text');
                try {
                    const ws = new WebSocket('ws://' + location.host + '/ws');
                    ws.onopen = () => { dot.style.background = 'var(--success)'; txt.textContent = 'ONLINE'; };
                    ws.onclose = () => { dot.style.background = 'var(--danger)'; txt.textContent = 'OFFLINE'; };
                } catch (e) { dot.style.background = 'var(--warning)'; txt.textContent = 'LOCAL'; }
            }, 2000);
        };
    </script>
</body>
</html>
