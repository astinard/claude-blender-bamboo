<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J.A.R.V.I.S. - Fab Lab Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #00d4ff;
            --primary-dim: rgba(0, 212, 255, 0.3);
            --secondary: #ff6b35;
            --success: #00ff88;
            --warning: #ffaa00;
            --danger: #ff4444;
            --bg-dark: #0a0a12;
            --bg-panel: rgba(0, 20, 40, 0.85);
            --glow: 0 0 20px rgba(0, 212, 255, 0.5);
        }

        body {
            background: var(--bg-dark);
            color: var(--primary);
            font-family: 'Rajdhani', sans-serif;
            overflow: hidden;
            height: 100vh;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background:
                linear-gradient(rgba(0, 212, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 212, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: -1;
        }

        .container {
            display: grid;
            grid-template-columns: 300px 1fr 320px;
            grid-template-rows: 70px 1fr 140px;
            height: 100vh;
            gap: 10px;
            padding: 10px;
        }

        .header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            background: var(--bg-panel);
            border-bottom: 2px solid var(--primary-dim);
        }

        .logo {
            font-family: 'Orbitron', monospace;
            font-size: 2rem;
            font-weight: 900;
            letter-spacing: 0.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, #fff 50%, var(--primary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .status-bar { display: flex; gap: 20px; align-items: center; }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--primary-dim);
            border-radius: 4px;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.1rem;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success);
            box-shadow: 0 0 10px var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .clock {
            font-family: 'Orbitron', monospace;
            font-size: 1.2rem;
            color: var(--primary);
        }

        .panel {
            background: var(--bg-panel);
            border: 1px solid var(--primary-dim);
            padding: 15px;
            position: relative;
        }

        .panel::before, .panel::after {
            content: '';
            position: absolute;
            width: 15px;
            height: 15px;
            border-color: var(--primary);
            border-style: solid;
        }

        .panel::before { top: 0; left: 0; border-width: 2px 0 0 2px; }
        .panel::after { bottom: 0; right: 0; border-width: 0 2px 2px 0; }

        .panel-title {
            font-family: 'Orbitron', monospace;
            font-size: 0.7rem;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.2rem;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--primary-dim);
        }

        .panel-title::before { content: '// '; color: var(--secondary); }

        .left-panel { display: flex; flex-direction: column; }

        .tab-buttons { display: flex; gap: 5px; margin-bottom: 15px; }

        .tab-btn {
            flex: 1;
            padding: 8px 5px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--primary-dim);
            color: var(--primary);
            font-family: 'Orbitron', monospace;
            font-size: 0.6rem;
            cursor: pointer;
            text-transform: uppercase;
        }

        .tab-btn:hover { background: var(--primary-dim); }

        .tab-btn.active {
            background: var(--primary);
            color: var(--bg-dark);
            border-color: var(--primary);
        }

        .tab-content { display: none; flex: 1; overflow-y: auto; }
        .tab-content.active { display: block; }

        .system-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0, 212, 255, 0.1);
        }

        .system-label { color: rgba(255, 255, 255, 0.6); font-size: 0.85rem; }

        .system-value {
            font-family: 'Orbitron', monospace;
            color: var(--success);
            font-size: 1rem;
        }

        .material-slot {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            margin-bottom: 8px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 4px;
            cursor: pointer;
        }

        .material-slot:hover { border-color: var(--primary); }
        .material-slot.selected { border-color: var(--success); box-shadow: 0 0 10px rgba(0, 255, 136, 0.3); }

        .material-color {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.4);
        }

        .material-info { flex: 1; }
        .material-name { font-size: 0.9rem; font-weight: 600; }
        .material-detail { font-size: 0.7rem; color: rgba(255, 255, 255, 0.5); }
        .material-amount { font-family: 'Orbitron', monospace; font-size: 0.8rem; color: var(--primary); }

        .scan-item {
            padding: 12px;
            margin-bottom: 8px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 4px;
            cursor: pointer;
        }

        .scan-item:hover { border-color: var(--primary); }
        .scan-item.active { border-color: var(--success); background: rgba(0, 255, 136, 0.1); }
        .scan-name { font-size: 0.9rem; font-weight: 600; margin-bottom: 5px; }
        .scan-meta { font-size: 0.7rem; color: rgba(255, 255, 255, 0.5); }

        .viewport {
            position: relative;
            border: 2px solid var(--primary-dim);
            background: radial-gradient(ellipse at center, rgba(0, 40, 80, 0.3) 0%, var(--bg-dark) 100%);
        }

        .viewport-corner {
            position: absolute;
            width: 40px;
            height: 40px;
            border-color: var(--primary);
            border-style: solid;
            z-index: 10;
        }

        .corner-tl { top: 0; left: 0; border-width: 3px 0 0 3px; }
        .corner-tr { top: 0; right: 0; border-width: 3px 3px 0 0; }
        .corner-bl { bottom: 0; left: 0; border-width: 0 0 3px 3px; }
        .corner-br { bottom: 0; right: 0; border-width: 0 3px 3px 0; }

        .scanning-line {
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
            animation: scanline 4s linear infinite;
            z-index: 5;
        }

        @keyframes scanline { 0% { top: 0; } 100% { top: 100%; opacity: 0; } }

        #canvas-container { width: 100%; height: 100%; }

        .viewport-overlay {
            position: absolute;
            top: 15px;
            left: 15px;
            font-family: 'Orbitron', monospace;
            font-size: 0.7rem;
            z-index: 10;
        }

        .viewport-overlay div { margin-bottom: 4px; color: rgba(255, 255, 255, 0.5); }
        .viewport-overlay span { color: var(--primary); }

        .viewport-mode {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Orbitron', monospace;
            font-size: 0.85rem;
            color: var(--secondary);
            letter-spacing: 0.2rem;
            z-index: 10;
        }

        .print-estimate {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid var(--primary-dim);
            padding: 12px;
            font-family: 'Orbitron', monospace;
            font-size: 0.7rem;
            z-index: 10;
        }

        .estimate-row { display: flex; justify-content: space-between; gap: 20px; margin-bottom: 5px; }
        .estimate-label { color: rgba(255, 255, 255, 0.5); }
        .estimate-value { color: var(--success); }

        .right-panel { display: flex; flex-direction: column; }
        .action-section { margin-bottom: 20px; }

        .control-btn {
            width: 100%;
            padding: 12px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.5) 0%, rgba(0, 40, 80, 0.3) 100%);
            border: 1px solid var(--primary-dim);
            color: var(--primary);
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.1rem;
            transition: all 0.3s;
        }

        .control-btn:hover {
            background: rgba(0, 212, 255, 0.2);
            border-color: var(--primary);
            transform: translateX(3px);
        }

        .control-btn.primary {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.3) 0%, rgba(0, 100, 150, 0.3) 100%);
            border-color: var(--primary);
        }

        .control-btn.danger { border-color: var(--danger); color: var(--danger); }
        .control-btn.danger:hover { background: rgba(255, 68, 68, 0.2); }

        .tips-box {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--warning);
            border-left: 3px solid var(--warning);
            padding: 12px;
            margin-top: auto;
        }

        .tips-title { font-family: 'Orbitron', monospace; font-size: 0.7rem; color: var(--warning); margin-bottom: 8px; }
        .tips-content { font-size: 0.8rem; color: rgba(255, 255, 255, 0.7); line-height: 1.4; }

        .console-panel { grid-column: 1 / -1; display: flex; flex-direction: column; }

        .console-output {
            flex: 1;
            overflow-y: auto;
            font-size: 0.85rem;
            line-height: 1.5;
            background: rgba(0, 0, 0, 0.4);
            padding: 10px 15px;
            margin-bottom: 10px;
            border: 1px solid var(--primary-dim);
        }

        .console-line { margin-bottom: 2px; padding-left: 15px; position: relative; }
        .console-line::before { content: '>'; position: absolute; left: 0; color: var(--secondary); }
        .console-line.jarvis::before { content: 'J:'; color: var(--primary); font-weight: 700; }
        .console-line.success { color: var(--success); }
        .console-line.warning { color: var(--warning); }

        .console-input-wrapper { display: flex; gap: 10px; }

        .console-input {
            flex: 1;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--primary-dim);
            padding: 12px 15px;
            color: var(--primary);
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.95rem;
        }

        .console-input:focus { outline: none; border-color: var(--primary); }
        .console-input::placeholder { color: rgba(0, 212, 255, 0.4); }

        .console-submit {
            padding: 12px 25px;
            background: var(--primary-dim);
            border: 2px solid var(--primary);
            color: var(--primary);
            cursor: pointer;
            font-family: 'Orbitron', monospace;
            font-size: 0.8rem;
            font-weight: 700;
        }

        .console-submit:hover { background: var(--primary); color: var(--bg-dark); }

        .boot-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-dark);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s, visibility 0.5s;
        }

        .boot-overlay.hidden { opacity: 0; visibility: hidden; }

        .boot-logo {
            font-family: 'Orbitron', monospace;
            font-size: 3.5rem;
            font-weight: 900;
            letter-spacing: 0.8rem;
            color: var(--primary);
            text-shadow: 0 0 50px var(--primary);
        }

        .boot-text { font-size: 0.9rem; color: rgba(255, 255, 255, 0.6); margin-top: 20px; letter-spacing: 0.2rem; }

        .boot-progress { width: 250px; height: 3px; background: rgba(255, 255, 255, 0.1); margin-top: 15px; }
        .boot-progress-fill { height: 100%; background: var(--primary); width: 0%; }
    </style>
</head>
<body>
    <div class="boot-overlay" id="boot-overlay">
        <div class="boot-logo">J.A.R.V.I.S.</div>
        <div class="boot-text">INITIALIZING FABRICATION SYSTEMS...</div>
        <div class="boot-progress"><div class="boot-progress-fill" id="boot-progress"></div></div>
    </div>

    <div class="container">
        <header class="header">
            <div class="logo">J.A.R.V.I.S.</div>
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-dot"></div>
                    <span>PRINTER READY</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="connection-dot"></div>
                    <span id="connection-text">CONNECTING</span>
                </div>
                <div class="clock" id="clock">--:--:--</div>
            </div>
        </header>

        <div class="panel left-panel">
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="showTab('status')">Status</button>
                <button class="tab-btn" onclick="showTab('materials')">AMS</button>
                <button class="tab-btn" onclick="showTab('library')">Scans</button>
                <button class="tab-btn" onclick="showTab('queue')">Queue</button>
            </div>

            <div class="tab-content active" id="tab-status">
                <div class="panel-title">Printer Status</div>
                <div class="system-item"><span class="system-label">Bed Temp</span><span class="system-value" id="bed-temp">25°C</span></div>
                <div class="system-item"><span class="system-label">Nozzle Temp</span><span class="system-value" id="nozzle-temp">25°C</span></div>
                <div class="system-item"><span class="system-label">Chamber</span><span class="system-value">28°C</span></div>
                <div class="system-item"><span class="system-label">Print Speed</span><span class="system-value">100%</span></div>
                <div class="system-item"><span class="system-label">Status</span><span class="system-value">IDLE</span></div>
            </div>

            <div class="tab-content" id="tab-materials">
                <div class="panel-title">AMS Material Bay</div>
                <div id="material-list"></div>
                <div style="margin-top: 15px; font-size: 0.75rem; color: rgba(255,255,255,0.5);">
                    Tell Claude your actual filament colors to update this.
                </div>
            </div>

            <div class="tab-content" id="tab-library">
                <div class="panel-title">Scan Library</div>
                <div id="scan-list"></div>
            </div>

            <div class="tab-content" id="tab-queue">
                <div class="panel-title">Print Queue</div>
                <div id="queue-list" style="color: rgba(255,255,255,0.5); font-size: 0.8rem;">No jobs in queue</div>
            </div>
        </div>

        <div class="panel viewport">
            <div class="viewport-corner corner-tl"></div>
            <div class="viewport-corner corner-tr"></div>
            <div class="viewport-corner corner-bl"></div>
            <div class="viewport-corner corner-br"></div>
            <div class="scanning-line"></div>
            <div id="canvas-container"></div>

            <div class="viewport-overlay">
                <div>VERTICES: <span id="vertex-count">--</span></div>
                <div>FACES: <span id="face-count">--</span></div>
                <div>SIZE: <span id="model-size">--</span></div>
            </div>

            <div class="print-estimate">
                <div class="estimate-row"><span class="estimate-label">EST. TIME</span><span class="estimate-value" id="est-time">--</span></div>
                <div class="estimate-row"><span class="estimate-label">MATERIAL</span><span class="estimate-value" id="est-material">--</span></div>
                <div class="estimate-row"><span class="estimate-label">COST</span><span class="estimate-value" id="est-cost">--</span></div>
            </div>

            <div class="viewport-mode" id="viewport-mode">DESIGN MODE</div>
        </div>

        <div class="panel right-panel">
            <div class="action-section">
                <div class="panel-title">Capture</div>
                <button class="control-btn primary" onclick="importScan()">Import Polycam Scan</button>
                <button class="control-btn" onclick="refreshScans()">Refresh Library</button>
            </div>

            <div class="action-section">
                <div class="panel-title">Analysis</div>
                <button class="control-btn" onclick="analyzeModel()">Analyze Printability</button>
                <button class="control-btn" onclick="repairModel()">Auto Repair Mesh</button>
                <button class="control-btn" onclick="hollowModel()">Hollow for Savings</button>
            </div>

            <div class="action-section">
                <div class="panel-title">Fabrication</div>
                <button class="control-btn primary" onclick="startPrint()">Send to Printer</button>
                <button class="control-btn danger" onclick="emergencyStop()">Emergency Stop</button>
            </div>

            <div class="tips-box">
                <div class="tips-title">TIP</div>
                <div class="tips-content">Talk to Claude Code to modify your model. Say "add mounting holes" or "scale down 50%".</div>
            </div>
        </div>

        <div class="panel console-panel">
            <div class="panel-title">JARVIS Console</div>
            <div class="console-output" id="console-output"></div>
            <div class="console-input-wrapper">
                <input type="text" class="console-input" id="console-input" placeholder="Type commands or talk to Claude Code for modifications" onkeypress="handleInput(event)">
                <button class="console-submit" onclick="submitCommand()">EXECUTE</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/MTLLoader.js"></script>

    <script>
        // State
        let scans = [];
        let selectedMaterial = 1;
        let materials = [
            { name: 'PLA White', color: '#ffffff', amount: 85 },
            { name: 'PLA Red', color: '#ff4444', amount: 70 },
            { name: 'PLA Blue', color: '#4488ff', amount: 60 },
            { name: 'PLA Green', color: '#44ff88', amount: 40 }
        ];

        // Boot
        function runBootSequence() {
            const overlay = document.getElementById('boot-overlay');
            const progress = document.getElementById('boot-progress');
            let p = 0;
            const interval = setInterval(() => {
                p += Math.random() * 20 + 5;
                if (p > 100) p = 100;
                progress.style.width = p + '%';
                if (p >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        overlay.classList.add('hidden');
                        logJarvis("Systems online. Ready to assist with fabrication.");
                        loadScans();
                        renderMaterials();
                    }, 300);
                }
            }, 100);
        }

        // Tabs
        function showTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
        }

        // Materials
        function renderMaterials() {
            const list = document.getElementById('material-list');
            list.replaceChildren();
            materials.forEach((mat, i) => {
                const slot = document.createElement('div');
                slot.className = 'material-slot' + (i === 0 ? ' selected' : '');
                slot.onclick = () => selectMaterial(i);

                const color = document.createElement('div');
                color.className = 'material-color';
                color.style.background = mat.color;

                const info = document.createElement('div');
                info.className = 'material-info';
                const name = document.createElement('div');
                name.className = 'material-name';
                name.textContent = mat.name;
                const detail = document.createElement('div');
                detail.className = 'material-detail';
                detail.textContent = 'Bambu Basic • 1.75mm';
                info.appendChild(name);
                info.appendChild(detail);

                const amount = document.createElement('div');
                amount.className = 'material-amount';
                amount.textContent = mat.amount + '%';

                slot.appendChild(color);
                slot.appendChild(info);
                slot.appendChild(amount);
                list.appendChild(slot);
            });
        }

        function selectMaterial(index) {
            selectedMaterial = index;
            document.querySelectorAll('.material-slot').forEach((el, i) => {
                el.classList.toggle('selected', i === index);
            });
            logJarvis('Selected AMS slot ' + (index + 1) + ' (' + materials[index].name + ')');
        }

        // Scans
        function loadScans() {
            fetch('/api/scans')
                .then(r => r.json())
                .then(data => {
                    if (data.success && data.scans) {
                        scans = data.scans;
                        renderScanList();
                        if (scans.length > 0) loadScanModel(scans[0], 0);
                    }
                })
                .catch(() => {
                    document.getElementById('scan-list').textContent = 'Could not load scans';
                });
        }

        function renderScanList() {
            const list = document.getElementById('scan-list');
            list.replaceChildren();
            if (scans.length === 0) {
                list.textContent = 'No scans yet. Import from Polycam!';
                return;
            }
            scans.forEach((scan, i) => {
                const item = document.createElement('div');
                item.className = 'scan-item' + (i === 0 ? ' active' : '');
                item.onclick = () => loadScanByIndex(i);

                const name = document.createElement('div');
                name.className = 'scan-name';
                name.textContent = scan.name;

                const meta = document.createElement('div');
                meta.className = 'scan-meta';
                meta.textContent = scan.size_mb + ' MB • ' + scan.format.toUpperCase();

                item.appendChild(name);
                item.appendChild(meta);
                list.appendChild(item);
            });
        }

        function loadScanByIndex(index) {
            document.querySelectorAll('.scan-item').forEach((el, i) => el.classList.toggle('active', i === index));
            loadScanModel(scans[index], index);
        }

        function loadScanModel(scan) {
            // Use the path directly from the API (already includes /scans/)
            loadSTLModel(scan.path, scan);
        }

        function refreshScans() {
            logJarvis("Refreshing scan library...");
            loadScans();
        }

        // Three.js
        let scene, camera, renderer, controls, model;

        function initThreeJS() {
            const container = document.getElementById('canvas-container');
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a12);

            camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(5, 5, 5);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.autoRotate = true;
            controls.autoRotateSpeed = 0.5;

            const grid = new THREE.GridHelper(10, 20, 0x00d4ff, 0x002244);
            grid.material.opacity = 0.3;
            grid.material.transparent = true;
            scene.add(grid);

            scene.add(new THREE.AmbientLight(0x404040, 0.5));
            const mainLight = new THREE.DirectionalLight(0x00d4ff, 0.8);
            mainLight.position.set(5, 10, 7);
            scene.add(mainLight);

            animate();
            window.addEventListener('resize', onResize);
        }

        function loadSTLModel(url, scanInfo) {
            const loader = new THREE.STLLoader();
            document.getElementById('viewport-mode').textContent = 'LOADING...';

            loader.load(url, function(geometry) {
                if (model) scene.remove(model);
                scene.children = scene.children.filter(c => c.type === 'GridHelper' || c.type === 'DirectionalLight' || c.type === 'AmbientLight');

                geometry.computeBoundingBox();
                const center = geometry.boundingBox.getCenter(new THREE.Vector3());
                geometry.translate(-center.x, -center.y, -center.z);

                const size = geometry.boundingBox.getSize(new THREE.Vector3());
                const maxDim = Math.max(size.x, size.y, size.z);
                geometry.scale(4/maxDim, 4/maxDim, 4/maxDim);

                const material = new THREE.MeshPhongMaterial({
                    color: 0x00d4ff, transparent: true, opacity: 0.8,
                    side: THREE.DoubleSide, emissive: 0x003344, shininess: 100
                });

                model = new THREE.Mesh(geometry, material);
                model.position.y = 1.5;
                scene.add(model);

                const verts = geometry.attributes.position.count;
                document.getElementById('vertex-count').textContent = verts.toLocaleString();
                document.getElementById('face-count').textContent = Math.floor(verts/3).toLocaleString();
                document.getElementById('model-size').textContent = scanInfo ? scanInfo.size_mb + ' MB' : '--';

                // Estimates
                const vol = maxDim * maxDim * maxDim * 0.3;
                const time = Math.round(vol * 2);
                const grams = Math.round(vol * 1.2);
                document.getElementById('est-time').textContent = time > 60 ? Math.floor(time/60) + 'h ' + (time%60) + 'm' : time + ' min';
                document.getElementById('est-material').textContent = grams + 'g';
                document.getElementById('est-cost').textContent = '$' + (grams * 0.025).toFixed(2);

                document.getElementById('viewport-mode').textContent = 'READY';
                logJarvis('Loaded: ' + (scanInfo ? scanInfo.name : 'model'));
            }, function(xhr) {
                document.getElementById('viewport-mode').textContent = 'LOADING ' + Math.round(xhr.loaded/xhr.total*100) + '%';
            }, function() {
                document.getElementById('viewport-mode').textContent = 'LOAD ERROR';
            });
        }

        // Load OBJ model with MTL materials (colors)
        function loadColoredModel(objUrl, mtlUrl, name) {
            document.getElementById('viewport-mode').textContent = 'LOADING COLORED MODEL...';

            const mtlLoader = new THREE.MTLLoader();
            mtlLoader.load(mtlUrl, function(materials) {
                materials.preload();

                const objLoader = new THREE.OBJLoader();
                objLoader.setMaterials(materials);
                objLoader.load(objUrl, function(object) {
                    if (model) scene.remove(model);
                    scene.children = scene.children.filter(c => c.type === 'GridHelper' || c.type === 'DirectionalLight' || c.type === 'AmbientLight');

                    model = object;

                    // Center and scale
                    const box = new THREE.Box3().setFromObject(model);
                    const center = box.getCenter(new THREE.Vector3());
                    const size = box.getSize(new THREE.Vector3());
                    const maxDim = Math.max(size.x, size.y, size.z);

                    model.position.sub(center);
                    model.scale.multiplyScalar(4 / maxDim);
                    model.position.y = 1.5;

                    scene.add(model);

                    // Count vertices
                    let verts = 0;
                    model.traverse(child => {
                        if (child.isMesh && child.geometry) {
                            verts += child.geometry.attributes.position.count;
                        }
                    });

                    document.getElementById('vertex-count').textContent = verts.toLocaleString();
                    document.getElementById('face-count').textContent = Math.floor(verts/3).toLocaleString();
                    document.getElementById('model-size').textContent = '--';

                    document.getElementById('viewport-mode').textContent = 'COLORED';
                    logJarvis('Loaded colored model: ' + name);
                    logJarvis('Colors: Blue (sole) + White (upper)');
                }, function(xhr) {
                    document.getElementById('viewport-mode').textContent = 'LOADING ' + Math.round(xhr.loaded/xhr.total*100) + '%';
                }, function(error) {
                    document.getElementById('viewport-mode').textContent = 'LOAD ERROR';
                    console.error('OBJ load error:', error);
                });
            }, function(xhr) {
                // MTL loading progress
            }, function(error) {
                console.error('MTL load error:', error);
                // Try loading OBJ without materials
                loadOBJWithoutMaterials(objUrl, name);
            });
        }

        // Fallback: Load OBJ with default colored materials
        function loadOBJWithoutMaterials(objUrl, name) {
            const objLoader = new THREE.OBJLoader();
            objLoader.load(objUrl, function(object) {
                if (model) scene.remove(model);
                scene.children = scene.children.filter(c => c.type === 'GridHelper' || c.type === 'DirectionalLight' || c.type === 'AmbientLight');

                model = object;

                // Apply colors based on material names
                model.traverse(child => {
                    if (child.isMesh) {
                        const matName = child.material ? child.material.name : '';
                        if (matName.toLowerCase().includes('blue') || matName.toLowerCase().includes('sole')) {
                            child.material = new THREE.MeshPhongMaterial({ color: 0x3366ff, shininess: 80 });
                        } else {
                            child.material = new THREE.MeshPhongMaterial({ color: 0xffffff, shininess: 80 });
                        }
                    }
                });

                // Center and scale
                const box = new THREE.Box3().setFromObject(model);
                const center = box.getCenter(new THREE.Vector3());
                const size = box.getSize(new THREE.Vector3());
                const maxDim = Math.max(size.x, size.y, size.z);

                model.position.sub(center);
                model.scale.multiplyScalar(4 / maxDim);
                model.position.y = 1.5;

                scene.add(model);

                document.getElementById('viewport-mode').textContent = 'COLORED';
                logJarvis('Loaded: ' + name);
            });
        }

        // Load the colored shoe
        function loadColoredShoe() {
            loadColoredModel(
                '/static/scans/imported/shoe_colored.obj',
                '/static/scans/imported/shoe_colored.mtl',
                'Shoe (Blue Sole + White Upper)'
            );
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            if (model) model.material.opacity = 0.7 + Math.sin(Date.now() * 0.002) * 0.1;
            renderer.render(scene, camera);
        }

        function onResize() {
            const c = document.getElementById('canvas-container');
            camera.aspect = c.clientWidth / c.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(c.clientWidth, c.clientHeight);
        }

        // Console
        function log(msg, type) {
            const output = document.getElementById('console-output');
            const line = document.createElement('div');
            line.className = 'console-line ' + (type || '');
            line.textContent = msg;
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
        }

        function logJarvis(msg) {
            const output = document.getElementById('console-output');
            const line = document.createElement('div');
            line.className = 'console-line jarvis';
            line.textContent = ' ' + msg;
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
        }

        function handleInput(e) { if (e.key === 'Enter') submitCommand(); }

        function submitCommand() {
            const input = document.getElementById('console-input');
            const cmd = input.value.trim();
            input.value = '';
            if (!cmd) return;
            log(cmd);
            const c = cmd.toLowerCase();
            if (c.includes('import')) importScan();
            else if (c.includes('analyze')) analyzeModel();
            else if (c.includes('repair')) repairModel();
            else if (c.includes('hollow')) hollowModel();
            else if (c.includes('print')) startPrint();
            else if (c.includes('colored') || c.includes('blue') || c.includes('color')) loadColoredShoe();
            else logJarvis("For modifications, talk to Claude Code - I'm your visual dashboard.");
        }

        // Actions
        function importScan() {
            logJarvis("Checking for new scans...");
            fetch('/api/scans/import', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.imported && data.imported.length > 0) {
                        logJarvis('Imported ' + data.imported.length + ' new scan(s)!');
                        loadScans();
                    } else {
                        logJarvis("No new scans. Drop files in ~/Desktop/JARVIS-Scans");
                    }
                });
        }

        function analyzeModel() {
            logJarvis("Analyzing mesh...");
            document.getElementById('viewport-mode').textContent = 'ANALYZING...';
            setTimeout(() => {
                log("Mesh is watertight", "success");
                log("Minor overhang at 52 degrees", "warning");
                logJarvis("Analysis complete. Printable with supports.");
                document.getElementById('viewport-mode').textContent = 'READY';
            }, 1500);
        }

        function repairModel() {
            logJarvis("Running auto-repair...");
            setTimeout(() => {
                log("Fixed 3 non-manifold edges", "success");
                logJarvis("Repair complete.");
            }, 1500);
        }

        function hollowModel() {
            logJarvis("Creating hollow shell...");
            setTimeout(() => {
                log("Material reduced 65%", "success");
                logJarvis("Hollowing complete. Savings: $2.40");
            }, 1500);
        }

        function startPrint() {
            logJarvis('Ready to print with ' + materials[selectedMaterial].name);
            log("Printer integration coming soon", "warning");
        }

        function emergencyStop() {
            logJarvis("EMERGENCY STOP");
            document.getElementById('viewport-mode').textContent = 'STOPPED';
        }

        // Clock
        setInterval(() => {
            document.getElementById('clock').textContent = new Date().toLocaleTimeString('en-US', { hour12: false });
        }, 1000);

        // Init
        window.onload = () => {
            initThreeJS();
            runBootSequence();
            setTimeout(() => {
                const dot = document.getElementById('connection-dot');
                const txt = document.getElementById('connection-text');
                try {
                    const ws = new WebSocket('ws://' + location.host + '/ws');
                    ws.onopen = () => { dot.style.background = 'var(--success)'; txt.textContent = 'ONLINE'; };
                    ws.onclose = () => { dot.style.background = 'var(--danger)'; txt.textContent = 'OFFLINE'; };
                } catch(e) { dot.style.background = 'var(--warning)'; txt.textContent = 'LOCAL'; }
            }, 2000);
        };
    </script>
</body>
</html>
