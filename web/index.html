<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JARVIS - Fab Lab Control</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0a0a0f;
            color: #00d4ff;
            font-family: 'Courier New', monospace;
            overflow: hidden;
            height: 100vh;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                linear-gradient(rgba(0, 212, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 212, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: -1;
        }

        .container {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            grid-template-rows: 80px 1fr 150px;
            height: 100vh;
            gap: 10px;
            padding: 10px;
        }

        .header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            border: 1px solid rgba(0, 212, 255, 0.3);
            background: rgba(0, 20, 40, 0.8);
        }

        .logo {
            font-size: 2rem;
            font-weight: bold;
            letter-spacing: 0.5rem;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
        }

        .status-bar {
            display: flex;
            gap: 30px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #00ff88;
            box-shadow: 0 0 10px #00ff88;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .panel {
            border: 1px solid rgba(0, 212, 255, 0.3);
            background: rgba(0, 20, 40, 0.6);
            padding: 15px;
            position: relative;
            overflow: hidden;
        }

        .panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00d4ff, transparent);
            animation: scan 3s infinite;
        }

        @keyframes scan {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .panel-title {
            font-size: 0.8rem;
            color: #00d4ff;
            text-transform: uppercase;
            letter-spacing: 0.2rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0, 212, 255, 0.2);
        }

        .left-panel { grid-row: 2 / 3; }

        .system-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0, 212, 255, 0.1);
        }

        .system-label { color: #888; }
        .system-value { color: #00ff88; }

        .viewport {
            grid-row: 2 / 3;
            position: relative;
        }

        #canvas-container {
            width: 100%;
            height: 100%;
        }

        .viewport-overlay {
            position: absolute;
            top: 15px;
            left: 15px;
            pointer-events: none;
            font-size: 0.8rem;
            color: #888;
        }

        .viewport-corner {
            position: absolute;
            width: 30px;
            height: 30px;
            border-color: #00d4ff;
            border-style: solid;
            border-width: 0;
        }

        .corner-tl { top: 0; left: 0; border-top-width: 2px; border-left-width: 2px; }
        .corner-tr { top: 0; right: 0; border-top-width: 2px; border-right-width: 2px; }
        .corner-bl { bottom: 0; left: 0; border-bottom-width: 2px; border-left-width: 2px; }
        .corner-br { bottom: 0; right: 0; border-bottom-width: 2px; border-right-width: 2px; }

        .right-panel { grid-row: 2 / 3; }

        .control-btn {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            background: transparent;
            border: 1px solid rgba(0, 212, 255, 0.5);
            color: #00d4ff;
            font-family: inherit;
            font-size: 0.9rem;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.1rem;
            transition: all 0.3s;
        }

        .control-btn:hover {
            background: rgba(0, 212, 255, 0.2);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }

        .control-btn.primary {
            background: rgba(0, 212, 255, 0.3);
            border-color: #00d4ff;
        }

        .control-btn.danger {
            border-color: #ff4444;
            color: #ff4444;
        }

        .control-btn.danger:hover {
            background: rgba(255, 68, 68, 0.2);
        }

        .console-panel { grid-column: 1 / -1; }

        .console-output {
            height: 80px;
            overflow-y: auto;
            font-size: 0.85rem;
            line-height: 1.5;
            color: #00ff88;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            margin-bottom: 10px;
        }

        .console-line { margin-bottom: 2px; }
        .console-line.info { color: #00d4ff; }
        .console-line.success { color: #00ff88; }
        .console-line.warning { color: #ffaa00; }
        .console-line.error { color: #ff4444; }

        .console-input-wrapper {
            display: flex;
            gap: 10px;
        }

        .console-input {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 212, 255, 0.3);
            padding: 10px 15px;
            color: #00d4ff;
            font-family: inherit;
            font-size: 0.9rem;
        }

        .console-input:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }

        .console-submit {
            padding: 10px 20px;
            background: rgba(0, 212, 255, 0.3);
            border: 1px solid #00d4ff;
            color: #00d4ff;
            cursor: pointer;
            font-family: inherit;
        }

        .progress-container { margin: 15px 0; }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.8rem;
        }

        .progress-bar {
            height: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #00ff88);
            width: 0%;
            transition: width 0.3s;
        }

        .material-slot {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            margin-bottom: 5px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        .material-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .material-info { flex: 1; font-size: 0.8rem; }

        .material-level {
            width: 50px;
            height: 6px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 3px;
            overflow: hidden;
        }

        .material-level-fill {
            height: 100%;
            background: #00ff88;
        }

        .scanning-line {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00d4ff, transparent);
            animation: scanline 2s linear infinite;
        }

        @keyframes scanline {
            0% { top: 0; opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        .sound-toggle {
            background: transparent;
            border: 1px solid rgba(0, 212, 255, 0.5);
            color: #00d4ff;
            font-size: 1.2rem;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .sound-toggle:hover {
            background: rgba(0, 212, 255, 0.2);
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }

        .sound-toggle.muted {
            color: #666;
            border-color: #444;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">JARVIS</div>
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-dot"></div>
                    <span>SYSTEMS ONLINE</span>
                </div>
                <div class="status-item">
                    <div class="status-dot"></div>
                    <span>PRINTER READY</span>
                </div>
                <div class="status-item">
                    <div class="status-dot"></div>
                    <span>LASER STANDBY</span>
                </div>
                <div class="status-item" id="clock">--:--:--</div>
                <button class="sound-toggle" id="sound-toggle" onclick="toggleSound()" title="Toggle Sound">
                    üîä
                </button>
                <button class="sound-toggle" id="mic-toggle" onclick="toggleVoice()" title="Voice Control (Hold to Speak)">
                    üé§
                </button>
                <div class="status-item" id="connection-status">
                    <div class="status-dot" id="connection-dot" style="background: #ff4444; box-shadow: 0 0 10px #ff4444;"></div>
                    <span id="connection-text">OFFLINE</span>
                </div>
            </div>
        </header>

        <div class="panel left-panel">
            <div class="panel-title">System Status</div>
            <div class="system-item">
                <span class="system-label">Bed Temp</span>
                <span class="system-value" id="bed-temp">25.0¬∞C</span>
            </div>
            <div class="system-item">
                <span class="system-label">Nozzle Temp</span>
                <span class="system-value" id="nozzle-temp">25.0¬∞C</span>
            </div>
            <div class="system-item">
                <span class="system-label">Chamber</span>
                <span class="system-value">28.0¬∞C</span>
            </div>
            <div class="system-item">
                <span class="system-label">Print Speed</span>
                <span class="system-value">100%</span>
            </div>

            <div class="panel-title" style="margin-top: 20px;">Material Bay</div>
            <div class="material-slot">
                <div class="material-color" style="background: #ffffff;"></div>
                <div class="material-info">PLA White</div>
                <div class="material-level"><div class="material-level-fill" style="width: 80%;"></div></div>
            </div>
            <div class="material-slot">
                <div class="material-color" style="background: #ff4444;"></div>
                <div class="material-info">PLA Red</div>
                <div class="material-level"><div class="material-level-fill" style="width: 65%;"></div></div>
            </div>
            <div class="material-slot">
                <div class="material-color" style="background: #4444ff;"></div>
                <div class="material-info">PLA Blue</div>
                <div class="material-level"><div class="material-level-fill" style="width: 90%;"></div></div>
            </div>
            <div class="material-slot">
                <div class="material-color" style="background: #44ff44;"></div>
                <div class="material-info">PLA Green</div>
                <div class="material-level"><div class="material-level-fill" style="width: 45%;"></div></div>
            </div>
        </div>

        <div class="panel viewport">
            <div class="viewport-corner corner-tl"></div>
            <div class="viewport-corner corner-tr"></div>
            <div class="viewport-corner corner-bl"></div>
            <div class="viewport-corner corner-br"></div>
            <div class="scanning-line"></div>
            <div id="canvas-container"></div>
            <div class="viewport-overlay">
                <div>VERTICES: <span style="color: #00d4ff;">847,293</span></div>
                <div>FACES: <span style="color: #00d4ff;">1,694,582</span></div>
                <div>VOLUME: <span style="color: #00d4ff;">42.7 cm¬≥</span></div>
            </div>
        </div>

        <div class="panel right-panel">
            <div class="panel-title">Controls</div>
            <button class="control-btn primary" onclick="startScan()">Scan Object</button>
            <button class="control-btn" onclick="analyzeModel()">Analyze Mesh</button>
            <button class="control-btn" onclick="repairModel()">Auto Repair</button>
            <button class="control-btn" onclick="hollowModel()">Hollow Shell</button>

            <div class="panel-title" style="margin-top: 20px;">Fabrication</div>
            <button class="control-btn primary" onclick="startPrint()">Start Print</button>
            <button class="control-btn" onclick="startLaser()">Laser Cut</button>
            <button class="control-btn danger" onclick="emergencyStop()">Emergency Stop</button>

            <div class="panel-title" style="margin-top: 20px;">Tools</div>
            <button class="control-btn" onclick="launchBlender()">Launch Blender</button>

            <div class="progress-container" id="progress-container" style="display: none;">
                <div class="progress-label">
                    <span id="progress-label">Processing...</span>
                    <span id="progress-percent">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>
        </div>

        <div class="panel console-panel">
            <div class="panel-title">Command Console</div>
            <div class="console-output" id="console-output"></div>
            <div class="console-input-wrapper">
                <input type="text" class="console-input" id="console-input"
                       placeholder="Enter command (scan, print, analyze, status)..."
                       onkeypress="handleInput(event)">
                <button class="console-submit" onclick="submitCommand()">EXECUTE</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // JARVIS SOUND SYSTEM - Web Audio API
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        class JarvisSounds {
            constructor() {
                this.audioContext = null;
                this.masterGain = null;
                this.ambientOscillator = null;
                this.enabled = true;
                this.volume = 0.5;
                this.initialized = false;
            }

            init() {
                if (this.initialized) return;
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                this.masterGain = this.audioContext.createGain();
                this.masterGain.gain.value = this.volume;
                this.masterGain.connect(this.audioContext.destination);
                this.initialized = true;
            }

            ensureContext() {
                if (!this.initialized) this.init();
                if (this.audioContext.state === 'suspended') {
                    this.audioContext.resume();
                }
            }

            setVolume(vol) {
                this.volume = Math.max(0, Math.min(1, vol));
                if (this.masterGain) {
                    this.masterGain.gain.value = this.volume;
                }
            }

            playTone(frequency, duration, type = 'sine', volume = 0.5, fadeIn = 0.01, fadeOut = 0.05) {
                if (!this.enabled) return;
                this.ensureContext();

                const osc = this.audioContext.createOscillator();
                const gain = this.audioContext.createGain();
                const now = this.audioContext.currentTime;

                osc.type = type;
                osc.frequency.value = frequency;

                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(volume, now + fadeIn);
                gain.gain.setValueAtTime(volume, now + duration - fadeOut);
                gain.gain.linearRampToValueAtTime(0, now + duration);

                osc.connect(gain);
                gain.connect(this.masterGain);

                osc.start(now);
                osc.stop(now + duration);
            }

            playSweep(startFreq, endFreq, duration, type = 'sine', volume = 0.4) {
                if (!this.enabled) return;
                this.ensureContext();

                const osc = this.audioContext.createOscillator();
                const gain = this.audioContext.createGain();
                const now = this.audioContext.currentTime;

                osc.type = type;
                osc.frequency.setValueAtTime(startFreq, now);
                osc.frequency.exponentialRampToValueAtTime(endFreq, now + duration);

                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(volume, now + 0.02);
                gain.gain.setValueAtTime(volume, now + duration - 0.05);
                gain.gain.linearRampToValueAtTime(0, now + duration);

                osc.connect(gain);
                gain.connect(this.masterGain);

                osc.start(now);
                osc.stop(now + duration);
            }

            playChord(frequencies, duration, volume = 0.3) {
                if (!this.enabled) return;
                frequencies.forEach(freq => {
                    this.playTone(freq, duration, 'sine', volume / frequencies.length);
                });
            }

            playBeepSequence(frequencies, durations, gap = 0.05, volume = 0.4) {
                if (!this.enabled) return;
                this.ensureContext();

                let time = this.audioContext.currentTime;
                for (let i = 0; i < frequencies.length; i++) {
                    const osc = this.audioContext.createOscillator();
                    const gain = this.audioContext.createGain();
                    const dur = durations[i] || 0.1;

                    osc.type = 'sine';
                    osc.frequency.value = frequencies[i];

                    gain.gain.setValueAtTime(0, time);
                    gain.gain.linearRampToValueAtTime(volume, time + 0.01);
                    gain.gain.setValueAtTime(volume, time + dur - 0.02);
                    gain.gain.linearRampToValueAtTime(0, time + dur);

                    osc.connect(gain);
                    gain.connect(this.masterGain);

                    osc.start(time);
                    osc.stop(time + dur);

                    time += dur + gap;
                }
            }

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // SOUND EFFECTS
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

            boot() {
                this.playSweep(50, 400, 0.8, 'sine', 0.4);
                setTimeout(() => {
                    this.playBeepSequence([200, 300, 400, 600, 800], [0.1, 0.1, 0.1, 0.1, 0.2], 0.02, 0.35);
                }, 900);
                setTimeout(() => {
                    this.playChord([523.25, 659.25, 783.99], 0.5, 0.4);
                }, 1800);
            }

            ready() {
                this.playChord([523.25, 659.25, 783.99], 0.5, 0.4);
            }

            click() {
                this.playTone(1200, 0.05, 'sine', 0.25, 0.005, 0.02);
            }

            confirm() {
                this.playBeepSequence([600, 900], [0.1, 0.15], 0.02, 0.35);
            }

            error() {
                this.playBeepSequence([400, 300, 200], [0.15, 0.15, 0.2], 0.05, 0.45);
            }

            warning() {
                this.ensureContext();
                const now = this.audioContext.currentTime;
                for (let i = 0; i < 3; i++) {
                    const osc = this.audioContext.createOscillator();
                    const gain = this.audioContext.createGain();
                    osc.type = 'sine';
                    osc.frequency.value = 440;
                    gain.gain.setValueAtTime(0, now + i * 0.2);
                    gain.gain.linearRampToValueAtTime(0.3, now + i * 0.2 + 0.05);
                    gain.gain.linearRampToValueAtTime(0, now + i * 0.2 + 0.15);
                    osc.connect(gain);
                    gain.connect(this.masterGain);
                    osc.start(now + i * 0.2);
                    osc.stop(now + i * 0.2 + 0.2);
                }
            }

            success() {
                this.playChord([523.25, 659.25, 783.99, 1046.5], 0.6, 0.4);
            }

            scanStart() {
                this.playSweep(200, 2000, 0.5, 'sine', 0.35);
            }

            scanPulse() {
                this.ensureContext();
                const now = this.audioContext.currentTime;
                const osc = this.audioContext.createOscillator();
                const gain = this.audioContext.createGain();
                osc.type = 'sine';
                osc.frequency.value = 800;

                // Pulsing envelope
                gain.gain.setValueAtTime(0, now);
                for (let i = 0; i < 4; i++) {
                    gain.gain.linearRampToValueAtTime(0.2, now + i * 0.5 + 0.1);
                    gain.gain.linearRampToValueAtTime(0.05, now + i * 0.5 + 0.4);
                }
                gain.gain.linearRampToValueAtTime(0, now + 2);

                osc.connect(gain);
                gain.connect(this.masterGain);
                osc.start(now);
                osc.stop(now + 2);
            }

            scanComplete() {
                this.playBeepSequence([400, 600, 800, 1000], [0.08, 0.08, 0.08, 0.2], 0.02, 0.4);
            }

            processing() {
                this.ensureContext();
                const now = this.audioContext.currentTime;
                const osc = this.audioContext.createOscillator();
                const gain = this.audioContext.createGain();
                osc.type = 'sine';
                osc.frequency.value = 600;

                // Pulsing envelope
                gain.gain.setValueAtTime(0, now);
                for (let i = 0; i < 3; i++) {
                    gain.gain.linearRampToValueAtTime(0.15, now + i * 0.5 + 0.1);
                    gain.gain.linearRampToValueAtTime(0.05, now + i * 0.5 + 0.4);
                }
                gain.gain.linearRampToValueAtTime(0, now + 1.5);

                osc.connect(gain);
                gain.connect(this.masterGain);
                osc.start(now);
                osc.stop(now + 1.5);
            }

            printStart() {
                this.playSweep(100, 400, 0.8, 'sine', 0.35);
            }

            printLayer() {
                this.playTone(300, 0.03, 'sine', 0.15, 0.005, 0.01);
            }

            printComplete() {
                this.playBeepSequence([523.25, 659.25, 783.99, 1046.5, 1318.5], [0.1, 0.1, 0.1, 0.1, 0.3], 0.03, 0.4);
            }

            laserStart() {
                this.playSweep(1000, 200, 0.5, 'sawtooth', 0.25);
            }

            powerDown() {
                this.playSweep(800, 50, 1.2, 'sine', 0.35);
            }

            startAmbient() {
                if (!this.enabled || this.ambientOscillator) return;
                this.ensureContext();

                // Create ambient drone
                this.ambientOscillator = this.audioContext.createOscillator();
                const ambientGain = this.audioContext.createGain();
                this.ambientOscillator.type = 'sine';
                this.ambientOscillator.frequency.value = 60;
                ambientGain.gain.value = 0.03;

                this.ambientOscillator.connect(ambientGain);
                ambientGain.connect(this.masterGain);
                this.ambientOscillator.start();

                // Store reference for stopping
                this.ambientGain = ambientGain;
            }

            stopAmbient() {
                if (this.ambientOscillator) {
                    this.ambientOscillator.stop();
                    this.ambientOscillator = null;
                }
            }

            toggle() {
                this.enabled = !this.enabled;
                if (!this.enabled) {
                    this.stopAmbient();
                }
                return this.enabled;
            }
        }

        const sounds = new JarvisSounds();

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // THREE.JS SCENE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let scene, camera, renderer, controls, model;

        function initThreeJS() {
            const container = document.getElementById('canvas-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a0f);

            camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
            camera.position.set(5, 5, 5);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(width, height);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.autoRotate = true;
            controls.autoRotateSpeed = 1;

            const gridHelper = new THREE.GridHelper(10, 20, 0x00d4ff, 0x003344);
            scene.add(gridHelper);

            const ambientLight = new THREE.AmbientLight(0x404040, 0.5);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0x00d4ff, 0.8);
            directionalLight.position.set(5, 10, 7);
            scene.add(directionalLight);

            createPhoneCase();
            animate();
            window.addEventListener('resize', onWindowResize);
        }

        function createPhoneCase() {
            if (model) scene.remove(model);

            const shape = new THREE.Shape();
            const w = 1.5, h = 3, r = 0.2;
            shape.moveTo(-w/2 + r, -h/2);
            shape.lineTo(w/2 - r, -h/2);
            shape.quadraticCurveTo(w/2, -h/2, w/2, -h/2 + r);
            shape.lineTo(w/2, h/2 - r);
            shape.quadraticCurveTo(w/2, h/2, w/2 - r, h/2);
            shape.lineTo(-w/2 + r, h/2);
            shape.quadraticCurveTo(-w/2, h/2, -w/2, h/2 - r);
            shape.lineTo(-w/2, -h/2 + r);
            shape.quadraticCurveTo(-w/2, -h/2, -w/2 + r, -h/2);

            const geometry = new THREE.ExtrudeGeometry(shape, {
                steps: 1, depth: 0.2, bevelEnabled: true,
                bevelThickness: 0.05, bevelSize: 0.05, bevelSegments: 3
            });

            const material = new THREE.MeshPhongMaterial({
                color: 0x00d4ff, transparent: true, opacity: 0.8, side: THREE.DoubleSide
            });

            model = new THREE.Mesh(geometry, material);
            model.rotation.x = Math.PI / 2;
            model.position.y = 1.5;
            scene.add(model);

            const wireframeMaterial = new THREE.MeshBasicMaterial({
                color: 0x00ff88, wireframe: true, transparent: true, opacity: 0.3
            });
            const wireframe = new THREE.Mesh(geometry.clone(), wireframeMaterial);
            wireframe.rotation.x = Math.PI / 2;
            wireframe.position.y = 1.5;
            scene.add(wireframe);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            const container = document.getElementById('canvas-container');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }

        function log(message, type) {
            const output = document.getElementById('console-output');
            const line = document.createElement('div');
            line.className = 'console-line ' + (type || 'info');
            line.textContent = '> ' + message;
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
        }

        function handleInput(event) {
            if (event.key === 'Enter') submitCommand();
        }

        function submitCommand() {
            const input = document.getElementById('console-input');
            const command = input.value.trim().toLowerCase();
            input.value = '';
            if (!command) return;

            sounds.click();
            log('Command: ' + command, 'info');
            if (command.includes('scan')) startScan();
            else if (command.includes('print')) startPrint();
            else if (command.includes('analyze')) analyzeModel();
            else if (command.includes('repair')) repairModel();
            else if (command.includes('hollow')) hollowModel();
            else if (command.includes('status')) showStatus();
            else if (command.includes('stop')) emergencyStop();
            else if (command.includes('sound')) {
                const enabled = sounds.toggle();
                log('Sound effects ' + (enabled ? 'enabled' : 'disabled'), 'info');
            }
            else {
                sounds.warning();
                log('Unknown command. Try: scan, print, analyze, repair, hollow, status, sound', 'warning');
            }
        }

        function startScan() {
            sounds.confirm();
            sounds.scanStart();
            log('Initializing LiDAR scanner...', 'info');
            showProgress('Scanning', 3000);
            setTimeout(function() { sounds.scanPulse(); }, 500);
            setTimeout(function() {
                sounds.scanComplete();
                sounds.success();
                log('Scan complete! 847,293 vertices captured.', 'success');
            }, 3000);
        }

        function analyzeModel() {
            sounds.confirm();
            sounds.processing();
            log('Analyzing mesh topology...', 'info');
            showProgress('Analyzing', 2000);
            setTimeout(function() {
                sounds.success();
                log('Mesh is watertight and printable.', 'success');
            }, 2000);
        }

        function repairModel() {
            sounds.confirm();
            sounds.processing();
            log('Running auto-repair algorithm...', 'info');
            showProgress('Repairing', 2500);
            setTimeout(function() { sounds.warning(); log('Found 3 holes and 12 non-manifold edges...', 'warning'); }, 800);
            setTimeout(function() {
                sounds.success();
                log('Repaired 3 holes and 12 non-manifold edges.', 'success');
            }, 2500);
        }

        function hollowModel() {
            sounds.confirm();
            sounds.processing();
            log('Creating hollow shell (2mm walls)...', 'info');
            showProgress('Hollowing', 2000);
            setTimeout(function() {
                sounds.success();
                log('Hollowing complete. Material savings: 68%', 'success');
            }, 2000);
        }

        function startPrint() {
            sounds.confirm();
            sounds.printStart();
            log('Initiating print sequence...', 'info');
            log('Heating bed to 60C...', 'info');

            var bedTemp = 25;
            var bedInterval = setInterval(function() {
                bedTemp += 5;
                sounds.printLayer();
                document.getElementById('bed-temp').textContent = bedTemp + '¬∞C';
                if (bedTemp >= 60) {
                    clearInterval(bedInterval);
                    sounds.click();
                    log('Bed temperature reached.', 'success');

                    var nozzleTemp = 25;
                    var nozzleInterval = setInterval(function() {
                        nozzleTemp += 15;
                        sounds.printLayer();
                        document.getElementById('nozzle-temp').textContent = nozzleTemp + '¬∞C';
                        if (nozzleTemp >= 210) {
                            clearInterval(nozzleInterval);
                            sounds.click();
                            log('Nozzle temperature reached.', 'success');
                            log('Beginning fabrication...', 'info');
                            sounds.processing();
                            showProgress('Printing', 10000);
                            setTimeout(function() {
                                sounds.printComplete();
                                log('Print complete!', 'success');
                            }, 10000);
                        }
                    }, 200);
                }
            }, 200);
        }

        function startLaser() {
            sounds.confirm();
            sounds.laserStart();
            log('Preparing laser cutter...', 'info');
            sounds.warning();
            log('WARNING: Ensure safety enclosure is closed!', 'warning');
            showProgress('Laser Cutting', 5000);
            setTimeout(function() {
                sounds.success();
                log('Laser cutting complete.', 'success');
            }, 5000);
        }

        function emergencyStop() {
            sounds.error();
            log('EMERGENCY STOP ACTIVATED', 'error');
            document.getElementById('progress-container').style.display = 'none';
            sounds.powerDown();
            log('All operations halted. Systems safe.', 'warning');
        }

        function showStatus() {
            sounds.click();
            log('=== SYSTEM STATUS ===', 'info');
            log('Printer: IDLE', 'success');
            log('Laser: STANDBY', 'success');
            log('Material Bay: 4/4 slots loaded', 'success');
            sounds.confirm();
        }

        function toggleSound() {
            const enabled = sounds.toggle();
            const btn = document.getElementById('sound-toggle');
            if (enabled) {
                btn.textContent = 'üîä';
                btn.classList.remove('muted');
                sounds.confirm();
                log('Sound effects enabled', 'info');
            } else {
                btn.textContent = 'üîá';
                btn.classList.add('muted');
                log('Sound effects disabled', 'info');
            }
        }

        function showProgress(label, duration) {
            var container = document.getElementById('progress-container');
            var labelEl = document.getElementById('progress-label');
            var percentEl = document.getElementById('progress-percent');
            var fillEl = document.getElementById('progress-fill');

            container.style.display = 'block';
            labelEl.textContent = label + '...';

            var progress = 0;
            var interval = setInterval(function() {
                progress += 2;
                if (progress > 100) {
                    progress = 100;
                    clearInterval(interval);
                    setTimeout(function() { container.style.display = 'none'; }, 500);
                }
                percentEl.textContent = progress + '%';
                fillEl.style.width = progress + '%';
            }, duration / 50);
        }

        function updateClock() {
            var now = new Date();
            document.getElementById('clock').textContent = now.toLocaleTimeString('en-US', { hour12: false });
        }
        setInterval(updateClock, 1000);
        updateClock();

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // WEBSOCKET & API CONNECTION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let ws = null;
        let wsReconnectTimer = null;
        const API_BASE = window.location.origin;
        const WS_URL = `ws://${window.location.host}/ws`;

        function connectWebSocket() {
            if (ws && ws.readyState === WebSocket.OPEN) return;

            ws = new WebSocket(WS_URL);

            ws.onopen = function() {
                setConnectionStatus(true);
                log('Connected to JARVIS server', 'success');
                sounds.ready();
            };

            ws.onmessage = function(event) {
                const message = JSON.parse(event.data);
                handleServerMessage(message);
            };

            ws.onclose = function() {
                setConnectionStatus(false);
                log('Disconnected from server', 'warning');
                // Attempt reconnect after 3 seconds
                wsReconnectTimer = setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
        }

        function setConnectionStatus(connected) {
            const dot = document.getElementById('connection-dot');
            const text = document.getElementById('connection-text');
            if (connected) {
                dot.style.background = '#00ff88';
                dot.style.boxShadow = '0 0 10px #00ff88';
                text.textContent = 'ONLINE';
            } else {
                dot.style.background = '#ff4444';
                dot.style.boxShadow = '0 0 10px #ff4444';
                text.textContent = 'OFFLINE';
            }
        }

        function handleServerMessage(message) {
            switch (message.type) {
                case 'log':
                    log(message.data.message, message.data.level);
                    break;
                case 'status':
                    updateSystemStatus(message.data);
                    break;
                case 'connected':
                    updateSystemStatus(message.data);
                    break;
                case 'command_result':
                    // Command completed
                    break;
            }
        }

        function updateSystemStatus(status) {
            if (status.bed_temp !== undefined) {
                document.getElementById('bed-temp').textContent = status.bed_temp.toFixed(1) + '¬∞C';
            }
            if (status.nozzle_temp !== undefined) {
                document.getElementById('nozzle-temp').textContent = status.nozzle_temp.toFixed(1) + '¬∞C';
            }
            if (status.progress !== undefined && status.progress > 0) {
                showProgressFromStatus(status.message || 'Processing', status.progress);
            } else {
                document.getElementById('progress-container').style.display = 'none';
            }
        }

        function showProgressFromStatus(label, percent) {
            var container = document.getElementById('progress-container');
            var labelEl = document.getElementById('progress-label');
            var percentEl = document.getElementById('progress-percent');
            var fillEl = document.getElementById('progress-fill');

            container.style.display = 'block';
            labelEl.textContent = label;
            percentEl.textContent = Math.round(percent) + '%';
            fillEl.style.width = percent + '%';
        }

        async function apiCall(endpoint, method = 'POST', data = null) {
            try {
                const options = {
                    method: method,
                    headers: { 'Content-Type': 'application/json' }
                };
                if (data) options.body = JSON.stringify(data);

                const response = await fetch(API_BASE + '/api/' + endpoint, options);
                return await response.json();
            } catch (error) {
                log('API Error: ' + error.message, 'error');
                return { success: false, error: error.message };
            }
        }

        function sendWSCommand(command) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'command', data: command }));
            } else {
                log('Not connected to server', 'error');
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // VOICE RECOGNITION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let recognition = null;
        let isListening = false;

        function initVoiceRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                log('Voice recognition not supported in this browser', 'warning');
                return false;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onstart = function() {
                isListening = true;
                document.getElementById('mic-toggle').style.background = 'rgba(0, 255, 136, 0.3)';
                document.getElementById('mic-toggle').style.borderColor = '#00ff88';
                log('Listening...', 'info');
            };

            recognition.onresult = function(event) {
                const command = event.results[0][0].transcript;
                log('Voice: "' + command + '"', 'info');
                sounds.confirm();
                processVoiceCommand(command);
            };

            recognition.onerror = function(event) {
                log('Voice error: ' + event.error, 'error');
                sounds.error();
            };

            recognition.onend = function() {
                isListening = false;
                document.getElementById('mic-toggle').style.background = 'transparent';
                document.getElementById('mic-toggle').style.borderColor = 'rgba(0, 212, 255, 0.5)';
            };

            return true;
        }

        function toggleVoice() {
            if (!recognition && !initVoiceRecognition()) {
                sounds.error();
                return;
            }

            if (isListening) {
                recognition.stop();
            } else {
                sounds.click();
                recognition.start();
            }
        }

        function processVoiceCommand(command) {
            command = command.toLowerCase();

            // Use WebSocket if connected, otherwise API
            if (ws && ws.readyState === WebSocket.OPEN) {
                sendWSCommand(command);
            } else {
                // Fallback to local processing
                if (command.includes('scan')) startScan();
                else if (command.includes('print')) startPrint();
                else if (command.includes('analyze')) analyzeModel();
                else if (command.includes('repair')) repairModel();
                else if (command.includes('hollow')) hollowModel();
                else if (command.includes('laser') || command.includes('cut')) startLaser();
                else if (command.includes('stop') || command.includes('abort')) emergencyStop();
                else if (command.includes('blender')) launchBlender();
                else if (command.includes('status')) showStatus();
                else log('Unknown command: ' + command, 'warning');
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // BLENDER LAUNCHER
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function launchBlender() {
            sounds.confirm();
            log('Launching Blender...', 'info');

            const result = await apiCall('launch-blender');
            if (result.success) {
                sounds.success();
                log('Blender launched!', 'success');
            } else {
                sounds.error();
                log('Failed to launch Blender: ' + (result.error || 'Unknown error'), 'error');
            }
        }

        // Initialize sound on first user interaction (browser requirement)
        function initAudioOnInteraction() {
            sounds.init();
            sounds.boot();
            sounds.startAmbient();
            document.removeEventListener('click', initAudioOnInteraction);
            document.removeEventListener('keydown', initAudioOnInteraction);
        }

        window.onload = function() {
            initThreeJS();
            log('JARVIS Fabrication System initialized', 'info');
            log('All systems nominal', 'success');

            // Try to connect to backend server
            log('Connecting to server...', 'info');
            connectWebSocket();

            log('Click anywhere to enable audio...', 'info');
            log('Click üé§ or say "Jarvis" for voice control', 'info');
            log('Ready for command...', 'info');

            // Browser requires user interaction to start audio
            document.addEventListener('click', initAudioOnInteraction);
            document.addEventListener('keydown', initAudioOnInteraction);

            // Add hover sounds to buttons
            document.querySelectorAll('.control-btn').forEach(function(btn) {
                btn.addEventListener('mouseenter', function() {
                    if (sounds.initialized) {
                        sounds.playTone(800, 0.03, 'sine', 0.1);
                    }
                });
            });

            // Initialize voice recognition
            initVoiceRecognition();
        };
    </script>
</body>
</html>
